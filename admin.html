<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin ‚Ä¢ ‡§∞‡§ï‡•ç‡§§‡§¶‡§æ‡§§‡§æ ‡§™‡•ã‡§∞‡•ç‡§ü‡§≤</title>

  <!-- Tailwind + Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { devanagari: ['"Noto Sans Devanagari"', 'system-ui', 'sans-serif'] },
          colors: {
            saffron:{50:'#FFF4E8',100:'#FFE8D6',200:'#FFD7B3',300:'#FFC48A',400:'#FFA24D',500:'#FF7F0E',600:'#E06900',700:'#C25700',800:'#A34500',900:'#873800'},
            peach:{50:'#FFF7EF',100:'#FFEFE0',200:'#FFE3C6'}
          }
        }
      }
    }
  </script>
  <style>
    body{ font-family:"Noto Sans Devanagari",system-ui,sans-serif }
    .toast{ position:fixed; inset-inline:0; top:10px; margin-inline:auto; width:fit-content; z-index:50 }
    .modal{ transition:opacity .2s ease }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body class="min-h-screen bg-peach-50">
  <div id="toast" class="toast hidden"></div>

  <header class="bg-gradient-to-r from-orange-500 to-red-500 text-white shadow-lg">
      <div class="max-w-6xl mx-auto px-4 py-4 text-center">
        <div class="flex justify-center items-center gap-4">
          <img src="https://seva-pakhwada.in/assets/img/Sevapakhwada.png" alt="‡§∏‡•á‡§µ‡§æ ‡§™‡§ñ‡§µ‡§æ‡§°‡§º‡§æ Logo" class="h-14 sm:h-16 bg-white p-1 rounded-md">
          <h1 class="text-2xl sm:text-4xl font-extrabold">‡§≠‡§æ‡§∞‡§§‡•Ä‡§Ø ‡§ú‡§®‡§§‡§æ ‡§™‡§æ‡§∞‡•ç‡§ü‡•Ä ‡§ú‡§ø‡§≤‡§æ ‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞</h1>
        </div>
      </div>
  </header>

  <main class="max-w-6xl mx-auto p-4 space-y-4">
    <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-sm border text-center relative overflow-hidden">
        <div class="absolute -right-10 -bottom-10 opacity-20 pointer-events-none">
            <img src="https://i.ibb.co/9g0g4sM/MODI-069745253.png" alt="‡§®‡§∞‡•á‡§Ç‡§¶‡•ç‡§∞ ‡§Æ‡•ã‡§¶‡•Ä" class="w-60 h-auto">
        </div>
        <h2 class="text-3xl sm:text-5xl font-extrabold text-red-700 leading-tight">‡§è‡§°‡§Æ‡§ø‡§® ‡§™‡•à‡§®‡§≤</h2>
        <p class="mt-2 text-slate-600">‡§™‡•ã‡§∞‡•ç‡§ü‡§≤ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§® ‡§è‡§µ‡§Ç ‡§°‡§æ‡§ü‡§æ ‡§Ö‡§µ‡§≤‡•ã‡§ï‡§®</p>
         <div class="mt-4 flex items-center justify-center gap-3 flex-wrap">
             <span class="inline-flex items-center gap-2 bg-peach-50/80 rounded-2xl px-3 py-2 border text-sm">üß° <b>‡§∏‡•á‡§µ‡§æ ‡§π‡•Ä ‡§∏‡§Ç‡§ï‡§≤‡•ç‡§™</b></span>
             <span class="inline-flex items-center gap-2 bg-peach-50/80 rounded-2xl px-3 py-2 border text-sm"><b>‡§∏‡•á‡§µ‡§æ ‡§™‡§∞‡§Æ‡•ã ‡§ß‡§∞‡•ç‡§Æ</b> ü©∏</span>
        </div>
    </div>

    <!-- Admin Gate -->
    <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-sm border">
      <h2 class="text-lg font-semibold mb-2">Admin ‡§™‡§π‡•Å‡§Å‡§ö</h2>
      <div id="adminGate" class="space-y-3">
        <div class="flex items-center gap-2 flex-wrap">
            <input id="adminPin" type="password" class="rounded-xl border px-4 py-3" placeholder="Admin PIN" />
            <button id="btnUnlock" class="px-4 py-3 rounded-xl bg-red-600 text-white font-semibold">Unlock</button>
        </div>
        <div class="flex items-center gap-2 flex-wrap">
            <button id="btnGoogle" class="px-4 py-3 rounded-xl bg-blue-600 text-white font-semibold">Google ‡§∏‡•á Login ‡§ï‡§∞‡•á‡§Ç</button>
            <div id="whoami" class="text-sm text-slate-600 hidden">
              ‡§≤‡•â‡§ó ‡§á‡§®: <span id="userEmail" class="font-semibold"></span>
              <button id="btnLogout" class="ml-2 px-3 py-1 rounded-lg bg-slate-800 text-white text-xs">Logout</button>
            </div>
        </div>
      </div>
      <div id="adminOk" class="hidden text-green-700 font-semibold mt-2">‚úÖ Admin ‡§™‡§π‡•Å‡§Å‡§ö ‡§∏‡§ï‡•ç‡§∑‡§Æ</div>
    </div>

    <!-- Admin Area -->
    <div id="adminArea" class="hidden space-y-4">
      <!-- Exports -->
      <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-sm border">
        <h3 class="text-base font-semibold mb-3">‡§°‡§æ‡§ü‡§æ ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü</h3>
        <div class="flex items-center gap-3 flex-wrap">
            <button id="btnExportDonors" class="px-4 py-3 rounded-xl bg-slate-800 text-white font-semibold">‡§°‡•ã‡§®‡§∞ ‡§∏‡•Ç‡§ö‡•Ä (CSV)</button>
            <button id="btnExportDonations" class="px-4 py-3 rounded-xl bg-slate-800 text-white font-semibold">‡§¶‡§æ‡§® ‡§∏‡•Ç‡§ö‡•Ä (CSV)</button>
            <button id="btnExportMandalPDF" class="px-4 py-3 rounded-xl bg-emerald-700 text-white font-semibold">‡§Æ‡§Ç‡§°‡§≤ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü (PDF)</button>
            <button id="btnExportGroupPDF" class="px-4 py-3 rounded-xl bg-sky-700 text-white font-semibold">‡§ó‡•ç‡§∞‡•Å‡§™ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü (PDF)</button>
        </div>
      </div>
      
      <!-- Donation Log -->
      <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-sm border">
        <h3 class="text-base font-semibold mb-3">‡§∏‡•Ä‡§ß‡§æ ‡§¶‡§æ‡§® ‡§≤‡•â‡§ó ‡§ï‡§∞‡•á‡§Ç (‡§¨‡§ø‡§®‡§æ ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§ï‡•á)</h3>
        <div class="grid gap-3 sm:grid-cols-2">
            <div>
              <label class="text-sm text-slate-600">‡§°‡•ã‡§®‡§∞ ‡§ï‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞</label>
              <div class="flex items-center gap-2 mt-1">
                  <input id="searchDonorPhone" class="w-full rounded-xl border px-4 py-3" placeholder="10 ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§®‡§Ç‡§¨‡§∞ ‡§ñ‡•ã‡§ú‡•á‡§Ç" />
                  <button id="btnFindDonor" class="px-4 py-3 rounded-xl bg-slate-700 text-white">‡§ñ‡•ã‡§ú‡•á‡§Ç</button>
              </div>
              <div id="foundDonorInfo" class="mt-2 p-3 bg-slate-100 rounded-lg hidden text-sm"></div>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-sm text-slate-600">‡§Ø‡•Ç‡§®‡§ø‡§ü</label>
                <input type="number" min="1" id="d_units" class="mt-1 w-full rounded-xl border px-4 py-3" value="1" />
              </div>
              <div>
                <label class="text-sm text-slate-600">‡§§‡§æ‡§∞‡•Ä‡§ñ‡§º</label>
                <input type="date" id="d_date" class="mt-1 w-full rounded-xl border px-4 py-3" />
              </div>
            </div>
            <div>
              <label class="text-sm text-slate-600">‡§∞‡•ã‡§ó‡•Ä ‡§ï‡§æ ‡§®‡§æ‡§Æ</label>
              <input id="d_recipient" class="mt-1 w-full rounded-xl border px-4 py-3" placeholder="‡§ï‡§ø‡§∏‡§ï‡•ã ‡§¶‡§ø‡§Ø‡§æ?" />
            </div>
            <div>
              <label class="text-sm text-slate-600">‡§∞‡•ã‡§ó‡•Ä ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤</label>
              <input id="d_recipient_phone" class="mt-1 w-full rounded-xl border px-4 py-3" placeholder="10 ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§®‡§Ç‡§¨‡§∞" required />
            </div>
            <div>
              <label class="text-sm text-slate-600">‡§Ö‡§∏‡•ç‡§™‡§§‡§æ‡§≤/‡§∏‡•ç‡§•‡§æ‡§®</label>
              <input id="d_hospital" class="mt-1 w-full rounded-xl border px-4 py-3" placeholder="‡§ú‡•à‡§∏‡•á: ‡§ú‡§ø‡§≤‡§æ ‡§Ö‡§∏‡•ç‡§™‡§§‡§æ‡§≤" />
            </div>
            <div class="sm:col-span-2">
              <label class="text-sm text-slate-600">‡§®‡•ã‡§ü‡•ç‡§∏</label>
              <textarea id="d_notes" class="mt-1 w-full rounded-xl border px-4 py-3" rows="2"></textarea>
            </div>
            <div class="sm:col-span-2 flex items-center gap-3 flex-wrap">
              <button id="btnSaveDonation" class="px-4 py-3 rounded-xl bg-orange-500 text-white font-semibold">‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç</button>
            </div>
        </div>
      </div>
      
      <!-- Requests Management -->
      <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-sm border">
        <h3 class="text-base font-semibold mb-3 flex items-center gap-3">
            ‡§∞‡§ï‡•ç‡§§ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß
            <span id="requestNotification" class="hidden h-7 w-7 bg-red-500 text-white text-sm rounded-full flex items-center justify-center font-bold">0</span>
        </h3>
        <div class="overflow-x-auto">
            <table class="min-w-[1200px] w-full text-sm">
                <thead>
                    <tr class="bg-slate-100 text-slate-700">
                        <th class="p-2 text-left">‡§µ‡§ø‡§µ‡§∞‡§£</th>
                        <th class="p-2 text-left">‡§∏‡•ç‡§ü‡•á‡§ü‡§∏</th>
                        <th class="p-2 text-left">‡§ï‡§ø‡§∏‡§®‡•á ‡§¶‡§ø‡§Ø‡§æ (‡§°‡•ã‡§®‡§∞)</th>
                        <th class="p-2 text-left">‡§Ø‡•Ç‡§®‡§ø‡§ü</th>
                        <th class="p-2 text-left">‡§è‡§ï‡•ç‡§∂‡§®</th>
                    </tr>
                </thead>
                <tbody id="reqTbody"></tbody>
            </table>
        </div>
        <div id="requestsPagination" class="mt-3 text-center">
            <button id="btnSeeMoreRequests" class="px-4 py-2 rounded-lg bg-slate-200 hover:bg-slate-300 text-sm font-semibold">‡§î‡§∞ ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§¶‡•á‡§ñ‡•á‡§Ç</button>
        </div>
      </div>

      <!-- Donor List -->
      <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-sm border">
        <div class="flex items-center justify-between flex-wrap gap-2">
          <h3 class="text-base font-semibold">‡§°‡•ã‡§®‡§∞ ‡§∏‡•Ç‡§ö‡•Ä</h3>
          <div class="text-sm text-slate-500">‡§ï‡•Å‡§≤ ‡§°‡•ã‡§®‡§∞: <b id="donorCount">0</b></div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mt-2">
          <input id="fText" class="rounded-xl border px-4 py-3 text-base" placeholder="‡§®‡§æ‡§Æ/‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤/‡§™‡§§‡§æ" />
          <select id="fGroup" class="rounded-xl border px-4 py-3 text-base"></select>
          <select id="fMandal" class="rounded-xl border px-4 py-3 text-base"></select>
          <select id="fWilling" class="rounded-xl border px-4 py-3 text-base">
            <option value="">‡§∏‡§≠‡•Ä</option>
            <option value="yes">‡§á‡§ö‡•ç‡§õ‡•Å‡§ï</option>
            <option value="no">‡§Ö‡§®‡§ø‡§ö‡•ç‡§õ‡•Å‡§ï</option>
          </select>
        </div>
        <div class="mt-3 overflow-x-auto">
          <table class="min-w-full w-full text-sm">
            <thead>
              <tr class="bg-slate-100 text-slate-700">
                <th class="p-2 text-left">‡§®‡§æ‡§Æ</th>
                <th class="p-2 text-left">‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤</th>
                <th class="p-2 text-left">‡§¨‡•ç‡§≤‡§°</th>
                <th class="p-2 text-left">‡§Æ‡§Ç‡§°‡§≤</th>
                <th class="p-2 text-left">‡§™‡§§‡§æ</th>
                <th class="p-2 text-left">‡§Ü‡§ñ‡§º‡§ø‡§∞‡•Ä ‡§¶‡§æ‡§®</th>
                <th class="p-2 text-left">‡§è‡§ï‡•ç‡§∂‡§®</th>
              </tr>
            </thead>
            <tbody id="donorsTbody"></tbody>
          </table>
        </div>
        <div class="mt-3 flex items-center justify-between gap-3 flex-wrap">
          <div id="paginationInfo" class="text-sm text-slate-600"></div>
          <div class="flex items-center gap-2">
            <button id="pgPrev" class="px-3 py-1 rounded-lg border">‚óÄÔ∏è ‡§™‡§ø‡§õ‡§≤‡§æ</button>
            <span class="text-sm">‡§™‡•á‡§ú <b id="pgNum">1</b></span>
            <button id="pgNext" class="px-3 py-1 rounded-lg border">‡§Ö‡§ó‡§≤‡§æ ‚ñ∂Ô∏è</button>
          </div>
        </div>
      </div>
       <!-- Charts -->
      <div class="grid md:grid-cols-2 gap-4">
          <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-sm border">
            <h3 class="text-base font-semibold mb-3">‡§¨‡•ç‡§≤‡§° ‡§ó‡•ç‡§∞‡•Å‡§™ ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§°‡•ã‡§®‡§∞</h3>
            <div class="h-64"><canvas id="chartGroups"></canvas></div>
          </div>
          <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-sm border">
            <h3 class="text-base font-semibold mb-3">‡§Æ‡§Ç‡§°‡§≤ ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§°‡•ã‡§®‡§∞</h3>
            <div class="h-64"><canvas id="chartMandals"></canvas></div>
          </div>
      </div>
    </div>
  </main>

  <!-- Hidden elements for exports -->
  <div id="mandalSummaryCard" class="hidden fixed top-0 left-0 w-[800px] p-8 bg-white text-slate-800"></div>
  <div id="groupSummaryCard" class="hidden fixed top-0 left-0 w-[800px] p-8 bg-white text-slate-800"></div>

  <footer class="max-w-6xl mx-auto p-4 text-xs text-slate-500 text-center">¬© <span id="year"></span> ‡§≠‡§æ‡§∞‡§§‡•Ä‡§Ø ‡§ú‡§®‡§§‡§æ ‡§™‡§æ‡§∞‡•ç‡§ü‡•Ä ‚Ä¢ ‡§ú‡§ø‡§≤‡§æ ‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞</footer>

  <!-- Edit Donor Modal -->
  <div id="editModal" class="modal fixed inset-0 bg-black/40 hidden items-center justify-center z-50 p-4">
    <div class="bg-white w-full max-w-lg rounded-2xl p-5">
      <h2 class="text-xl font-bold mb-4">‡§°‡•ã‡§®‡§∞ ‡§è‡§°‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç</h2>
      <form id="editForm" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <input type="hidden" id="edit_id">
        <div>
            <label class="text-sm">‡§™‡•Ç‡§∞‡§æ ‡§®‡§æ‡§Æ</label>
            <input required id="edit_name" class="mt-1 w-full rounded-xl border px-4 py-3"/>
        </div>
        <div>
            <label class="text-sm">‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤</label>
            <input required id="edit_phone" pattern="[0-9]{10}" class="mt-1 w-full rounded-xl border px-4 py-3"/>
        </div>
        <div>
            <label class="text-sm">‡§¨‡•ç‡§≤‡§° ‡§ó‡•ç‡§∞‡•Å‡§™</label>
            <select required id="edit_group" class="mt-1 w-full rounded-xl border px-4 py-3"></select>
        </div>
        <div>
            <label class="text-sm">‡§Æ‡§Ç‡§°‡§≤</label>
            <select id="edit_mandal" class="mt-1 w-full rounded-xl border px-4 py-3"></select>
        </div>
        <div class="sm:col-span-2">
            <label class="text-sm">‡§™‡§§‡§æ</label>
            <input id="edit_address" class="mt-1 w-full rounded-xl border px-4 py-3"/>
        </div>
        <div>
            <label class="text-sm">‡§Ü‡§ñ‡§º‡§ø‡§∞‡•Ä ‡§∞‡§ï‡•ç‡§§‡§¶‡§æ‡§®</label>
            <input type="date" id="edit_last" class="mt-1 w-full rounded-xl border px-4 py-3"/>
        </div>
        <div>
           <label class="text-sm">‡§¶‡§æ‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§á‡§ö‡•ç‡§õ‡•Å‡§ï?</label>
           <select id="edit_willing" class="mt-1 w-full rounded-xl border px-4 py-3">
             <option value="yes">‡§π‡§æ‡§Å</option>
             <option value="no">‡§®‡§π‡•Ä‡§Ç</option>
           </select>
        </div>
        <div class="sm:col-span-2 flex items-center gap-3 mt-4">
            <button type="submit" class="px-5 py-2 rounded-xl bg-orange-500 text-white font-semibold">‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç</button>
            <button type="button" id="editCancel" class="px-5 py-2 rounded-xl bg-slate-200">‡§ï‡•à‡§Ç‡§∏‡§ø‡§≤</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const BLOOD_GROUPS = ["A+","A-","B+","B-","O+","O-","AB+","AB-"];
    const MANDALS = ["‡§Ö‡§®‡•ç‡§Ø","‡§≠‡•á‡§Ç‡§∏‡•ã‡§¶‡§æ","‡§≠‡§æ‡§®‡§™‡•Å‡§∞‡§æ","‡§ó‡§∞‡•ã‡§†","‡§Æ‡•á‡§≤‡§ñ‡•á‡§°‡§æ","‡§ñ‡•ú‡§æ‡§µ‡§¶‡§æ","‡§∂‡§æ‡§Æ‡§ó‡•ù","‡§∏‡•Å‡§µ‡§æ‡§∏‡§∞‡§æ","‡§¨‡§∏‡§æ‡§à","‡§∏‡•Ä‡§§‡§æ‡§Æ‡§ä","‡§ï‡•ç‡§Ø‡§æ‡§Æ‡§™‡•Å‡§∞","‡§∏‡•Ä‡§§‡§æ‡§Æ‡§ä ‡§ó‡•ç‡§∞‡§æ‡§Æ‡•Ä‡§£","‡§ó‡•Å‡§∞‡•ç‡§ú‡§∞ ‡§¨‡§∞‡§°‡§ø‡§Ø‡§æ","‡§ß‡•Å‡§Ç‡§ß‡§ß‡•ú‡§ï‡§æ","‡§¨‡•Å‡§¢‡§æ","‡§™‡§ø‡§™‡§≤‡§ø‡§Ø‡§æ ‡§Æ‡§Ç‡§°‡•Ä","‡§Æ‡§≤‡•ç‡§π‡§æ‡§∞‡§ó‡•ù","‡§¶‡§≤‡•ã‡§¶‡§æ","‡§Æ‡§ó‡§∞‡§æ‡§Æ‡§æ‡§§‡§æ ‡§ú‡•Ä","‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞ ‡§ó‡•ç‡§∞‡§æ‡§Æ‡•Ä‡§£","‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞ ‡§â‡§§‡•ç‡§§‡§∞","‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞ ‡§¶‡§ï‡•ç‡§∑‡§ø‡§£","‡§Ö‡§®‡•ç‡§Ø ‡§ú‡§ø‡§≤‡•á ‡§∏‡•á"];
    const $ = (id)=>document.getElementById(id);
    document.getElementById('year').textContent = new Date().getFullYear();
    const fmtTS = (ts)=>{ try{ const d = ts?.toDate? ts.toDate(): new Date(ts); return d.toLocaleDateString('en-GB'); }catch{ return '' } };
    const fmtDateForInput = (ts) => { try { const d = ts?.toDate? ts.toDate(): new Date(ts); return d.toISOString().split('T')[0]; } catch { return ''; } };
    
    function showToast(txt, ok=true){
      const t=$('toast');
      t.className='toast';
      t.innerHTML=`<div class="mx-auto max-w-lg bg-white border rounded-2xl shadow px-4 py-3 ${ok?'border-green-600':'border-red-600'}"><div class="text-sm ${ok?'text-green-700':'text-red-700'}">${txt}</div></div>`;
      setTimeout(()=>t.classList.add('hidden'), 3500);
    }
     const fill = (el, arr, first)=>{ el.innerHTML=''; if(first) el.insertAdjacentHTML('beforeend', `<option value="">${first}</option>`); arr.forEach(x=> el.insertAdjacentHTML('beforeend', `<option value="${x}">${x}</option>`)); }
  </script>

  <script type="module">
    const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js');
    const { getFirestore, collection, onSnapshot, query, orderBy, addDoc, updateDoc, deleteDoc, doc, serverTimestamp, getDoc, getDocs } =
      await import('https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js');
    const { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } =
      await import('https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js');
    
    const firebaseConfig = {
      apiKey: "AIzaSyA9LZaQJkAqr9F1YEFfRxa4aGiwvFevs9c",
      authDomain: "blodddonation-9c44e.firebaseapp.com",
      projectId: "blodddonation-9c44e",
      storageBucket: "blodddonation-9c44e.firebasestorage.app",
      messagingSenderId: "636578091772",
      appId: "1:636578091772:web:276d08168f8fc9c221fd79",
      measurementId: "G-3TPG0JCF3R"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    let adminOK = false;
    
    function grantAdminAccess() {
        adminOK = true;
        $('adminGate').classList.add('hidden');
        $('adminOk').classList.remove('hidden');
        $('adminArea').classList.remove('hidden');
    }
    
    $('btnUnlock').onclick = () => {
      const pin = ($('adminPin').value || '').trim();
      if(pin === '2412'){
        grantAdminAccess();
      } else {
        alert('‡§ó‡§≤‡§§ PIN');
      }
    };
    
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    $('btnGoogle').onclick = async ()=>{
      try { await signInWithPopup(auth, provider); } catch(e){ alert('Login error'); }
    };
    $('btnLogout').onclick = async ()=>{ await signOut(auth); };
    
    let ADMIN_EMAILS = [];
    function checkAuth() {
        onAuthStateChanged(auth, async (user) => {
          const who = $('whoami'), mailEl = $('userEmail');
          if (user) {
            try {
                const snap = await getDoc(doc(db, 'settings', 'admins'));
                ADMIN_EMAILS = (snap.exists() && Array.isArray(snap.data().emails)) ? snap.data().emails.map(e=>String(e||'').toLowerCase()) : [];
            } catch(e) { 
                console.error("Admin emails load error", e); 
                alert('Admin ‡§∏‡•Ç‡§ö‡•Ä ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§ ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§ú‡§æ‡§Å‡§ö‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§ú‡§æ ‡§∏‡§ï‡§§‡•Ä‡•§');
                return;
            }

            const email = (user.email||'').toLowerCase();
            mailEl.textContent = user.email || '';
            who.classList.remove('hidden');
            if(ADMIN_EMAILS.includes(email)){
              grantAdminAccess();
            } else {
              alert('‡§Ü‡§™‡§ï‡•á ‡§à‡§Æ‡•á‡§≤ ‡§ï‡•ã Admin ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§');
            }
          } else {
            who.classList.add('hidden');
          }
        });
    }
    checkAuth();
    
    let donors = [];
    let requests = [];
    let isInitialRequestsLoad = true;
    let requestsToShow = 3;
    let chartGroups, chartMandals;

    onSnapshot(query(collection(db,'donors'), orderBy('createdAt','desc')), snap=>{
      donors = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      $('donorCount').textContent = donors.length;
      renderDonorTable();
      renderRequestsTable(); 
      updateCharts();
    });

    onSnapshot(query(collection(db,'requests'), orderBy('createdAt','desc')), snap=>{
        requests = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        const newRequestsCount = requests.filter(r => (r.status || 'new') === 'new').length;
        const notificationBadge = $('requestNotification');
        if (newRequestsCount > 0) {
            notificationBadge.textContent = newRequestsCount;
            notificationBadge.classList.remove('hidden');
        } else {
            notificationBadge.classList.add('hidden');
        }

        snap.docChanges().forEach(change => {
            if (change.type === "added" && !isInitialRequestsLoad) {
                showToast("‡§®‡§Ø‡§æ ‡§∞‡§ï‡•ç‡§§ ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§π‡•Å‡§Ü!", true);
            }
        });
        isInitialRequestsLoad = false;
        renderRequestsTable();
    });
    
    const fText = $('fText'); const fGroup = $('fGroup'); const fMandal = $('fMandal'); const fWilling = $('fWilling');
    fill(fGroup, BLOOD_GROUPS, '‡§¨‡•ç‡§≤‡§° ‡§ó‡•ç‡§∞‡•Å‡§™'); fill(fMandal, MANDALS, '‡§Æ‡§Ç‡§°‡§≤');
    ;[fText,fGroup,fMandal,fWilling].forEach(el=> el.addEventListener('input', ()=>{ currentPage = 1; renderDonorTable(); }));
    const willingOk = (d)=> (d.willing===true || String(d.willing).toLowerCase()==='yes');
    
    const PAGE_SIZE = 10;
    let currentPage = 1;

    function renderDonorTable(){
      const tb=$('donorsTbody'); tb.innerHTML='';
      const t=(fText.value||'').toLowerCase(), g=fGroup.value, m=fMandal.value, w=fWilling.value;
      const filtered = donors.filter(d=>{
        const okText = !t || [d.name,d.phone,d.address].some(v=> (v||'').toLowerCase().includes(t));
        const okG = !g || d.bloodGroup===g;
        const okM = !m || d.mandal===m;
        const will = willingOk(d);
        const okW = !w || (w==='yes'? will : !will);
        return okText && okG && okM && okW;
      });

      const totalPages = Math.ceil(filtered.length / PAGE_SIZE);
      const start = (currentPage - 1) * PAGE_SIZE;
      const end = start + PAGE_SIZE;
      const pageRows = filtered.slice(start, end);

      pageRows.forEach(d=> tb.insertAdjacentHTML('beforeend', `
        <tr class="odd:bg-white even:bg-slate-50 hover:bg-peach-100">
          <td class="p-2 font-medium">${d.name||''}</td>
          <td class="p-2"><a class="underline" href="tel:${d.phone||''}">${d.phone||''}</a></td>
          <td class="p-2">${d.bloodGroup||''}</td>
          <td class="p-2">${d.mandal||''}</td>
          <td class="p-2">${d.address||''}</td>
          <td class="p-2">${d.lastDonationDate?fmtTS(d.lastDonationDate):'‚Äî'}</td>
          <td class="p-2">
            <div class="flex gap-2">
              <button data-action="edit" data-id="${d.id}" class="px-2 py-1 text-xs bg-blue-500 text-white rounded">‡§è‡§°‡§ø‡§ü</button>
              <button data-action="delete" data-id="${d.id}" class="px-2 py-1 text-xs bg-red-500 text-white rounded">‡§°‡§ø‡§≤‡•Ä‡§ü</button>
            </div>
          </td>
        </tr>`));
      
      $('pgNum').textContent = currentPage;
      $('paginationInfo').textContent = `‡§ï‡•Å‡§≤ ${filtered.length} ‡§Æ‡•á‡§Ç ‡§∏‡•á ${start+1}-${Math.min(end, filtered.length)} ‡§¶‡§ø‡§ñ‡§æ ‡§∞‡§π‡§æ ‡§π‡•à‡•§`;
      $('pgPrev').disabled = currentPage === 1;
      $('pgNext').disabled = currentPage === totalPages || filtered.length === 0;
    }

    $('pgPrev').onclick = () => { if(currentPage > 1) { currentPage--; renderDonorTable(); } };
    $('pgNext').onclick = () => { 
        const totalFiltered = donors.filter(d => {
            const t=(fText.value||'').toLowerCase(), g=fGroup.value, m=fMandal.value, w=fWilling.value;
            const okText = !t || [d.name,d.phone,d.address].some(v=> (v||'').toLowerCase().includes(t));
            const okG = !g || d.bloodGroup===g;
            const okM = !m || d.mandal===m;
            const will = willingOk(d);
            const okW = !w || (w==='yes'? will : !will);
            return okText && okG && okM && okW;
        }).length;
        if(currentPage < Math.ceil(totalFiltered / PAGE_SIZE)) {
            currentPage++;
            renderDonorTable();
        }
    };
    
    function donorOptions(selectedId, searchTerm = ''){
        const s = (searchTerm || '').toLowerCase();
        let filteredDonors = s 
            ? donors.filter(d => (d.name||'').toLowerCase().includes(s) || (d.phone||'').includes(s))
            : donors;

        const opts = ['<option value="">‚Äî ‡§°‡•ã‡§®‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç ‚Äî</option>'];
        const selectedDonor = donors.find(d => d.id === selectedId);
        if(selectedId && selectedDonor && !filteredDonors.some(d => d.id === selectedId)){
            filteredDonors.unshift(selectedDonor);
        }

        filteredDonors.slice(0, 50).forEach(d=>{ // Limit to 50 results for performance
            const sel = d.id === selectedId ? 'selected' : '';
            opts.push(`<option value="${d.id}" ${sel}>${d.name||''} (${d.phone})</option>`);
        });
        return opts.join('');
    }

    function renderRequestsTable(){
      const tb = $('reqTbody'); tb.innerHTML='';
      const rows = requests.slice(0, requestsToShow);

      rows.forEach(r=>{
        const status = (r.status||'new');
        const donorId = r.fulfilledByDonorId || '';
        const u = r.fulfilledUnits != null ? r.fulfilledUnits : (r.units||'');

        tb.insertAdjacentHTML('beforeend', `
          <tr class="odd:bg-white even:bg-slate-50 align-top border-b">
            <td class="p-2">
                <div class="font-medium">${r.requester||'-'} (${r.phone||''})</div>
                <div class="text-xs text-slate-500">‡§∞‡•ã‡§ó‡•Ä: ${r.patient||'-'}</div>
                <div class="text-xs text-slate-500">‡§ó‡•ç‡§∞‡•Å‡§™/‡§Ø‡•Ç‡§®‡§ø‡§ü: ${r.bloodGroup||'-'} / ${r.units||'-'}</div>
                <div class="text-xs text-slate-500">‡§∏‡•ç‡§•‡§æ‡§®: ${r.location||'-'}</div>
                <div class="text-xs text-slate-500">‡§Ö‡§∏‡•ç‡§™‡§§‡§æ‡§≤: ${r.hospital||'-'}</div>
                <div class="text-xs text-slate-400 mt-1">ID: ${r.id} | ${r.createdAt?fmtTS(r.createdAt):'‚Äî'}</div>
            </td>
            <td class="p-2">
              <select id="rq-status-${r.id}" class="w-full rounded-lg border px-2 py-1 text-sm">
                <option value="new" ${status==='new'?'selected':''}>New</option>
                <option value="pending" ${status==='pending'?'selected':''}>Pending</option>
                <option value="fulfilled" ${status==='fulfilled'?'selected':''}>Fulfilled</option>
                <option value="closed" ${status==='closed'?'selected':''}>Closed</option>
              </select>
            </td>
            <td class="p-2">
               <div class="flex flex-col gap-1">
                  <input type="text" id="rq-search-${r.id}" data-req-id="${r.id}" class="w-full rounded-lg border px-2 py-1 text-sm" placeholder="‡§®‡§æ‡§Æ/‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§∏‡•á ‡§ñ‡•ã‡§ú‡•á‡§Ç...">
                  <select id="rq-donor-${r.id}" class="w-full rounded-lg border px-2 py-1 text-sm">
                      ${donorOptions(donorId)}
                  </select>
              </div>
            </td>
            <td class="p-2">
              <input id="rq-units-${r.id}" type="number" min="1" class="w-20 rounded-lg border px-2 py-1 text-sm" value="${u||''}" placeholder="‡§Ø‡•Ç‡§®‡§ø‡§ü"/>
            </td>
            <td class="p-2">
              <button class="w-full px-3 py-2 rounded-lg bg-orange-500 text-white text-xs font-semibold" data-action="req-save" data-id="${r.id}">‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç</button>
              <div id="rq-msg-${r.id}" class="text-xs mt-1"></div>
            </td>
          </tr>
        `);
      });

      const seeMoreBtn = $('btnSeeMoreRequests');
      if (requests.length > requestsToShow) {
        seeMoreBtn.classList.remove('hidden');
      } else {
        seeMoreBtn.classList.add('hidden');
      }
    }
    
    $('btnSeeMoreRequests').onclick = () => {
        requestsToShow += 3;
        renderRequestsTable();
    };

    $('reqTbody').addEventListener('input', e => {
        const input = e.target.closest('input[id^="rq-search-"]');
        if (!input) return;
        const reqId = input.dataset.reqId;
        const donorSelect = $(`rq-donor-${reqId}`);
        const currentSelectedId = donorSelect.value;
        const searchTerm = input.value;
        donorSelect.innerHTML = donorOptions(currentSelectedId, searchTerm);
    });

    $('reqTbody').addEventListener('click', async (e)=>{
      const btn = e.target.closest('button[data-action="req-save"]'); 
      if(!btn || !adminOK) return;
      
      const id = btn.getAttribute('data-id');
      const req = requests.find(r=> r.id===id);
      if(!req) return;

      const status = $(`rq-status-${id}`).value;
      const donorId = $(`rq-donor-${id}`).value;
      const units = Number($(`rq-units-${id}`).value || 0);
      const msgEl = $(`rq-msg-${id}`);
      
      try {
        let updatePayload = { status, updatedAt: serverTimestamp() };
        let donor = null;

        if(donorId) {
            donor = donors.find(d => d.id === donorId);
            if(donor) {
              updatePayload.fulfilledByDonorId = donor.id;
              updatePayload.fulfilledByName = donor.name;
            }
        }
        if(units > 0) {
            updatePayload.fulfilledUnits = units;
        }

        await updateDoc(doc(db, 'requests', id), updatePayload);

        if(status === 'fulfilled' && donor && units > 0) {
            const donationPayload = {
                donorId: donor.id, donorName: donor.name, donorPhone: donor.phone,
                mandal: donor.mandal, bloodGroup: donor.bloodGroup,
                recipientName: req.patient || req.requester,
                recipientPhone: req.phone,
                units: units,
                hospital: req.hospital || req.location || '',
                date: new Date(),
                notes: `Request ID: ${id} ‡§∏‡•á ‡§≤‡•â‡§ó ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ`,
                createdAt: serverTimestamp(),
            };
            await addDoc(collection(db, 'donations'), donationPayload);
            await updateDoc(doc(db, 'donors', donor.id), { lastDonationDate: new Date() });
            showToast('‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•Å‡§Ü ‡§î‡§∞ ‡§¶‡§æ‡§® ‡§≤‡•â‡§ó ‡§π‡•ã ‡§ó‡§Ø‡§æ‡•§', true);
        } else {
            showToast('‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•ã ‡§ó‡§Ø‡§æ‡•§', true);
        }
        msgEl.textContent = '‚úÖ Saved';
        setTimeout(() => msgEl.textContent = '', 2000);

      } catch (err) {
        console.error("Error saving request:", err);
        showToast('‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§', false);
        msgEl.textContent = '‚ùå Error';
      }
    });

    // Donation Log Logic
    let selectedDonorForLog = null;
    $('btnFindDonor').onclick = () => {
        const phone = $('searchDonorPhone').value.trim();
        const infoDiv = $('foundDonorInfo');
        selectedDonorForLog = null;
        infoDiv.classList.add('hidden');
        if (phone.length !== 10) {
            infoDiv.innerHTML = `<span class="text-red-600">‡§ï‡•É‡§™‡§Ø‡§æ 10 ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§®‡§Ç‡§¨‡§∞ ‡§°‡§æ‡§≤‡•á‡§Ç‡•§</span>`;
            infoDiv.classList.remove('hidden');
            return;
        }
        const found = donors.find(d => d.phone === phone);
        if (found) {
            selectedDonorForLog = found;
            infoDiv.innerHTML = `<b>‡§®‡§æ‡§Æ:</b> ${found.name} <br> <b>‡§¨‡•ç‡§≤‡§° ‡§ó‡•ç‡§∞‡•Å‡§™:</b> ${found.bloodGroup} <br> <b>‡§Æ‡§Ç‡§°‡§≤:</b> ${found.mandal}`;
            infoDiv.classList.remove('hidden');
        } else {
            infoDiv.innerHTML = `<span class="text-red-600">‡§á‡§∏ ‡§®‡§Ç‡§¨‡§∞ ‡§∏‡•á ‡§ï‡•ã‡§à ‡§°‡•ã‡§®‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§</span>`;
            infoDiv.classList.remove('hidden');
        }
    };
    
    $('btnSaveDonation').onclick = async ()=>{
      if(!adminOK) return alert('Admin ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï');
      if(!selectedDonorForLog) return alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡§π‡§≤‡•á ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§∏‡•á ‡§°‡•ã‡§®‡§∞ ‡§ñ‡•ã‡§ú‡•á‡§Ç‡•§');
      const d = selectedDonorForLog;
      const recipientPhone = $('d_recipient_phone').value.trim();
      if (!recipientPhone) return alert('‡§∞‡•ã‡§ó‡•Ä ‡§ï‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø ‡§π‡•à‡•§');
      
      const payload = {
        donorId: d.id, donorName: d.name, donorPhone: d.phone,
        mandal: d.mandal, bloodGroup: d.bloodGroup,
        recipientName: $('d_recipient').value.trim(),
        recipientPhone: recipientPhone,
        units: Number($('d_units').value||1),
        hospital: $('d_hospital').value.trim(),
        date: $('d_date').value ? new Date($('d_date').value) : new Date(),
        notes: $('d_notes').value.trim(),
        createdAt: serverTimestamp(),
      };
       
      await addDoc(collection(db,'donations'), payload);
      await updateDoc(doc(db,'donors', d.id), { lastDonationDate: payload.date });
      showToast('‡§¶‡§æ‡§® ‡§™‡•ç‡§∞‡§µ‡§ø‡§∑‡•ç‡§ü‡§ø ‡§∏‡•á‡§µ ‡§π‡•ã ‡§ó‡§Ø‡§æ‡•§', true);
      ["d_recipient","d_recipient_phone","d_hospital","d_date","d_notes", "searchDonorPhone"].forEach(i=> $(i).value='');
      $('d_units').value='1';
      $('foundDonorInfo').classList.add('hidden');
      selectedDonorForLog = null;
    };
    
    $('donorsTbody').addEventListener('click', e => {
        const btn = e.target.closest('button[data-action]');
        if (!btn || !adminOK) return;
        const id = btn.dataset.id;
        if (btn.dataset.action === 'delete') {
            if (confirm(`‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§á‡§∏ ‡§°‡•ã‡§®‡§∞ ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?`)) {
                deleteDoc(doc(db, 'donors', id))
                    .then(() => showToast('‡§°‡•ã‡§®‡§∞ ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§'))
                    .catch(() => showToast('‡§π‡§ü‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§', false));
            }
        }
        if (btn.dataset.action === 'edit') {
            const donor = donors.find(d => d.id === id);
            if (donor) {
                $('edit_id').value = donor.id;
                $('edit_name').value = donor.name || '';
                $('edit_phone').value = donor.phone || '';
                $('edit_group').value = donor.bloodGroup || '';
                $('edit_mandal').value = donor.mandal || '';
                $('edit_address').value = donor.address || '';
                $('edit_last').value = donor.lastDonationDate ? fmtDateForInput(donor.lastDonationDate) : '';
                $('edit_willing').value = willingOk(donor) ? 'yes' : 'no';
                $('editModal').classList.remove('hidden');
                $('editModal').classList.add('flex');
            }
        }
    });
    
    fill($('edit_group'), BLOOD_GROUPS);
    fill($('edit_mandal'), MANDALS);
    $('editCancel').onclick = () => {
        $('editModal').classList.add('hidden');
        $('editModal').classList.remove('flex');
    };
    $('editForm').addEventListener('submit', async e => {
        e.preventDefault();
        const id = $('edit_id').value;
        const payload = {
            name: $('edit_name').value, phone: $('edit_phone').value, bloodGroup: $('edit_group').value,
            mandal: $('edit_mandal').value, address: $('edit_address').value,
            lastDonationDate: $('edit_last').value ? new Date($('edit_last').value) : null,
            willing: $('edit_willing').value === 'yes',
        };
        await updateDoc(doc(db, 'donors', id), payload);
        showToast('‡§°‡•ã‡§®‡§∞ ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•ã ‡§ó‡§Ø‡§æ‡•§');
        $('editModal').classList.add('hidden');
        $('editModal').classList.remove('flex');
    });

    function updateCharts() {
        if (!donors.length) return;
        const elG = $('chartGroups');
        if (chartGroups) chartGroups.destroy();
        const groupCounts = BLOOD_GROUPS.map(g => donors.filter(d => d.bloodGroup === g && willingOk(d)).length);
        chartGroups = new Chart(elG, { type: 'bar', data: { labels: BLOOD_GROUPS, datasets: [{ label: '‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§°‡•ã‡§®‡§∞', data: groupCounts, backgroundColor: 'rgba(255, 127, 14, 0.6)' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { precision: 0, beginAtZero: true } } } } });

        const elM = $('chartMandals');
        if (chartMandals) chartMandals.destroy();
        const mandalMap = new Map();
        donors.forEach(d => { if(willingOk(d)) { const k = d.mandal || '‡§Ö‡§®‡§ø‡§∞‡•ç‡§¶‡§ø‡§∑‡•ç‡§ü'; mandalMap.set(k, (mandalMap.get(k) || 0) + 1); } });
        const mandalPairs = Array.from(mandalMap.entries()).sort((a,b) => b[1] - a[1]);
        chartMandals = new Chart(elM, { type:'bar', data:{ labels: mandalPairs.map(p=>p[0]), datasets:[{ label:'‡§°‡•ã‡§®‡§∞', data: mandalPairs.map(p=>p[1]), backgroundColor: 'rgba(23, 190, 207, 0.6)' }] }, options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ ticks:{ precision:0, beginAtZero: true }}}} });
    }
    
    function downloadCSV(filename, rows){
      const esc = (v)=> '"'+String(v).replaceAll('"','""')+'"';
      const csv = rows.map(r=> r.map(esc).join(',')).join('\n');
      const blob = new Blob([`\uFEFF${csv}`], {type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url);
    }

    $('btnExportDonors').onclick = ()=>{
      const header = ['‡§®‡§æ‡§Æ','‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤','‡§¨‡•ç‡§≤‡§° ‡§ó‡•ç‡§∞‡•Å‡§™','‡§Æ‡§Ç‡§°‡§≤','‡§™‡§§‡§æ','‡§Ü‡§ñ‡§º‡§ø‡§∞‡•Ä ‡§¶‡§æ‡§®','‡§á‡§ö‡•ç‡§õ‡•Å‡§ï'];
      const rows = donors.map(d=> ([ d.name||'', d.phone||'', d.bloodGroup||'', d.mandal||'', (d.address||'').replace(/\n/g,' '), (d.lastDonationDate?fmtTS(d.lastDonationDate):''), (willingOk(d)?'yes':'no') ]));
      downloadCSV('donors.csv', [header, ...rows]);
    };

    $('btnExportDonations').onclick = async ()=>{
      const donationsSnap = await getDocs(query(collection(db, 'donations'), orderBy('date', 'desc')));
      const donationsData = donationsSnap.docs.map(d => d.data());
      const header = ['‡§§‡§æ‡§∞‡•Ä‡§ñ‡§º','‡§°‡•ã‡§®‡§∞ ‡§ï‡§æ ‡§®‡§æ‡§Æ','‡§°‡•ã‡§®‡§∞ ‡§ï‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤','‡§¨‡•ç‡§≤‡§° ‡§ó‡•ç‡§∞‡•Å‡§™','‡§Æ‡§Ç‡§°‡§≤','‡§Ø‡•Ç‡§®‡§ø‡§ü','‡§∞‡•ã‡§ó‡•Ä ‡§ï‡§æ ‡§®‡§æ‡§Æ','‡§∞‡•ã‡§ó‡•Ä ‡§ï‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤','‡§Ö‡§∏‡•ç‡§™‡§§‡§æ‡§≤'];
      const rows = donationsData.map(x=> ([ (x.date?fmtTS(x.date):''), x.donorName||'', x.donorPhone||'', x.bloodGroup||'', x.mandal||'', x.units||'', x.recipientName||'', x.recipientPhone||'', (x.hospital||'').replace(/\n/g,' ') ]));
      downloadCSV('donations.csv', [header, ...rows]);
    };
    
    function buildSummaryTable(title, tableHeader, dataMap, cardElement) {
        const rows = Array.from(dataMap.entries()).sort((a,b)=> a[0].localeCompare(b[0]));
        let tableHTML = `<tr class="bg-slate-100"><th class="p-2 text-left">${tableHeader}</th><th class="p-2 text-left">‡§ï‡•Å‡§≤ ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§°‡•ã‡§®‡§∞</th></tr>`;
        rows.forEach(([key,count])=>{ tableHTML += `<tr class="odd:bg-white even:bg-slate-50"><td class="p-2">${key}</td><td class="p-2">${count}</td></tr>`; });
        cardElement.innerHTML = `<div class="text-center"><div class="text-2xl font-extrabold">‡§≠‡§æ‡§∞‡§§‡•Ä‡§Ø ‡§ú‡§®‡§§‡§æ ‡§™‡§æ‡§∞‡•ç‡§ü‡•Ä ‚Ä¢ ‡§ú‡§ø‡§≤‡§æ ‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞</div><div class="text-3xl font-extrabold text-red-700 mt-1">‡§∞‡§ï‡•ç‡§§‡§¶‡§æ‡§§‡§æ ‡§™‡•ã‡§∞‡•ç‡§ü‡§≤</div><div class="text-sm text-slate-600 mt-1">‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï: ${new Date().toLocaleDateString('hi-IN')}</div><div class="mt-2 text-base">${title}</div></div><div class="mt-6"><table class="w-full text-base">${tableHTML}</table></div>`;
    }

    async function exportElementAsPDF(el, filename){
      const { jsPDF } = window.jspdf;
      el.classList.remove('hidden');
      const canvas = await html2canvas(el, {scale:2, backgroundColor:'#ffffff'});
      el.classList.add('hidden');
      const imgData = canvas.toDataURL('image/jpeg', 0.95);
      const pdf = new jsPDF({ unit:'pt', format:'a4' });
      const pageWidth = pdf.internal.pageSize.getWidth();
      const imgWidth = pageWidth - 80;
      const imgHeight = canvas.height * (imgWidth / canvas.width);
      pdf.addImage(imgData, 'JPEG', 40, 40, imgWidth, imgHeight);
      pdf.save(filename);
    }

    $('btnExportMandalPDF').onclick = async ()=>{
      const map = new Map();
      donors.forEach(d=>{ const k=d.mandal||'‡§Ö‡§®‡§ø‡§∞‡•ç‡§¶‡§ø‡§∑‡•ç‡§ü'; map.set(k,(map.get(k)||0)+1); });
      const card = $('mandalSummaryCard');
      buildSummaryTable('‡§Æ‡§Ç‡§°‡§≤-‡§µ‡§æ‡§∞ ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§°‡•ã‡§®‡§∞ ‡§∏‡§æ‡§∞', '‡§Æ‡§Ç‡§°‡§≤', map, card);
      await exportElementAsPDF(card, 'mandal-summary.pdf');
      showToast('‡§Æ‡§Ç‡§°‡§≤ ‡§∏‡§æ‡§∞ PDF ‡§§‡•à‡§Ø‡§æ‡§∞‡•§');
    };

    $('btnExportGroupPDF').onclick = async ()=>{
      const map = new Map();
      donors.forEach(d=>{ const k=d.bloodGroup||'‡§Ö‡§®‡§ø‡§∞‡•ç‡§¶‡§ø‡§∑‡•ç‡§ü'; map.set(k,(map.get(k)||0)+1); });
      const card = $('groupSummaryCard');
      buildSummaryTable('‡§¨‡•ç‡§≤‡§° ‡§ó‡•ç‡§∞‡•Å‡§™-‡§µ‡§æ‡§∞ ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§°‡•ã‡§®‡§∞ ‡§∏‡§æ‡§∞', '‡§¨‡•ç‡§≤‡§° ‡§ó‡•ç‡§∞‡•Å‡§™', map, card);
      await exportElementAsPDF(card, 'blood-group-summary.pdf');
      showToast('‡§¨‡•ç‡§≤‡§° ‡§ó‡•ç‡§∞‡•Å‡§™ ‡§∏‡§æ‡§∞ PDF ‡§§‡•à‡§Ø‡§æ‡§∞‡•§');
    };
  </script>
</body>
</html>

