<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin ‚Ä¢ ‡§∞‡§ï‡•ç‡§§‡§¶‡§æ‡§§‡§æ ‡§™‡•ã‡§∞‡•ç‡§ü‡§≤</title>

  <!-- Tailwind + Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { devanagari: ['"Noto Sans Devanagari"', 'system-ui', 'sans-serif'] },
          colors: {
            saffron:{50:'#FFF4E8',100:'#FFE8D6',200:'#FFD7B3',300:'#FFC48A',400:'#FFA24D',500:'#FF7F0E',600:'#E06900',700:'#C25700',800:'#A34500',900:'#873800'},
            peach:{50:'#FFF7EF',100:'#FFEFE0',200:'#FFE3C6'}
          }
        }
      }
    }
  </script>
  <style>
    body { font-family: "Noto Sans Devanagari", system-ui, sans-serif; }
    .toast { position: fixed; inset-inline: 0; top: 10px; margin-inline: auto; width: fit-content; z-index: 50; }
    .modal { transition: opacity .2s ease }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="min-h-screen bg-slate-50">
  <div id="toast" class="toast hidden"></div>

  <!-- Top strip -->
  <header class="bg-gradient-to-r from-saffron-800 to-saffron-600 text-white">
    <div class="max-w-6xl mx-auto px-4 py-2"></div>
  </header>

  <!-- Hero -->
  <section class="relative overflow-hidden">
    <div class="absolute inset-0">
      <div class="absolute inset-0 bg-[url('https://upload.wikimedia.org/wikipedia/commons/6/6d/Official_portrait_of_prime_minister_of_India%2C_Narendra_Modi.jpg')] bg-cover bg-center opacity-20"></div>
      <div class="absolute inset-0 bg-gradient-to-b from-white/90 via-peach-50/90 to-white/95"></div>
    </div>
    <div class="relative max-w-6xl mx-auto px-4 py-6">
      <div class="mx-auto text-center bg-white/70 backdrop-blur-sm border rounded-3xl px-5 sm:px-8 py-6 shadow">
        <div class="text-slate-900 text-3xl sm:text-4xl font-extrabold">‡§≠‡§æ‡§∞‡§§‡•Ä‡§Ø ‡§ú‡§®‡§§‡§æ ‡§™‡§æ‡§∞‡•ç‡§ü‡•Ä ‚Ä¢ ‡§ú‡§ø‡§≤‡§æ ‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞</div>
        <div class="mt-1 text-6xl sm:text-7xl font-extrabold text-red-700 leading-tight">‡§∞‡§ï‡•ç‡§§‡§¶‡§æ‡§§‡§æ ‡§™‡•ã‡§∞‡•ç‡§ü‡§≤</div>
        <p class="mt-3 text-slate-700 text-base sm:text-lg max-w-3xl mx-auto">
          ‡§Æ‡§æ‡§®‡§®‡•Ä‡§Ø ‡§™‡•ç‡§∞‡§ß‡§æ‡§®‡§Æ‡§Ç‡§§‡•ç‡§∞‡•Ä ‡§∂‡•ç‡§∞‡•Ä ‡§®‡§∞‡•á‡§Ç‡§¶‡•ç‡§∞ ‡§Æ‡•ã‡§¶‡•Ä ‡§ú‡•Ä ‡§ï‡•á ‡§ú‡§®‡•ç‡§Æ ‡§¶‡§ø‡§µ‡§∏ <b>17 ‡§∏‡§ø‡§§‡§Æ‡•ç‡§¨‡§∞</b> ‡§ï‡•á ‡§Ö‡§µ‡§∏‡§∞ ‡§™‡§∞, ‡§Ø‡§π ‡§™‡•ã‡§∞‡•ç‡§ü‡§≤ ‡§Ü‡§Æ ‡§®‡§æ‡§ó‡§∞‡§ø‡§ï‡•ã‡§Ç ‡§ï‡•Ä ‡§∏‡•á‡§µ‡§æ ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∞‡•ç‡§™‡§ø‡§§ ‡§π‡•à‡•§
        </p>
        <!-- badges -->
        <div class="mt-4 flex items-center justify-between gap-3">
          <span class="inline-flex items-center gap-2 bg-white/90 rounded-2xl px-3 py-2 border text-sm">
            <span>üß°</span><b>‡§∏‡•á‡§µ‡§æ ‡§∏‡§π‡•Ä ‡§∏‡§Ç‡§ï‡§≤‡•ç‡§™</b>
          </span>
          <div class="inline-flex items-center gap-3 bg-white rounded-2xl px-3 py-2 border">
            <img src="Sevapakhwada.png" alt="‡§∏‡•á‡§µ‡§æ ‡§™‡§ñ‡§µ‡§æ‡§°‡§º‡§æ 2025" class="h-14 sm:h-16 w-auto rounded">
            <span class="text-sm">‡§∞‡§ï‡•ç‡§§‡§¶‡§æ‡§® ‚Ä¢ ‡§∏‡•á‡§µ‡§æ ‚Ä¢ ‡§∏‡§π‡§Ø‡•ã‡§ó</span>
          </div>
          <span class="inline-flex items-center gap-2 bg-white/90 rounded-2xl px-3 py-2 border text-sm">
            <b>‡§∏‡•á‡§µ‡§æ ‡§™‡§∞‡§Æ‡•ã ‡§ß‡§∞‡•ç‡§Æ</b><span>ü©∏</span>
          </span>
        </div>
      </div>
    </div>
  </section>

  <main class="max-w-6xl mx-auto p-4 space-y-4">
    <!-- Admin Gate -->
    <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-sm border">
      <h2 class="text-lg font-semibold mb-2">Admin ‡§™‡§π‡•Å‡§Å‡§ö</h2>
      <div id="adminGate" class="flex flex-col sm:flex-row items-start sm:items-center gap-2">
        <div class="flex items-center gap-2">
          <input id="adminPin" type="password" class="rounded-xl border px-4 py-3" placeholder="Admin PIN" />
          <button id="btnUnlock" class="px-4 py-3 rounded-xl bg-red-600 text-white">Unlock</button>
        </div>
        <span class="text-xs text-slate-500">(‡§°‡•á‡§Æ‡•ã PIN: 2720 ‚Äî ‡§Ö‡§∏‡§≤‡•Ä ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ Firestore Rules/Auth ‡§∏‡•á)</span>
      </div>
      <div id="adminOk" class="hidden text-green-700 font-semibold">Admin ‡§∏‡§ï‡•ç‡§∑‡§Æ</div>
    </div>

    <!-- Telegram Settings -->
    <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-sm border">
      <h3 class="text-base font-semibold mb-3">Telegram ‡§Ö‡§≤‡§∞‡•ç‡§ü</h3>
      <div class="grid sm:grid-cols-3 gap-3 items-end">
        <div class="sm:col-span-2">
          <label class="text-sm text-slate-600">Chat IDs (‡§ï‡•â‡§Æ‡§æ ‡§∏‡•á ‡§Ö‡§≤‡§ó ‡§ï‡§∞‡•á‡§Ç) ‚Äî DM/‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§ï‡•á ‡§≤‡§ø‡§è numeric id, ‡§ö‡•à‡§®‡§≤ ‡§ï‡•á ‡§≤‡§ø‡§è @username, ‡§™‡•ç‡§∞‡§æ‡§á‡§µ‡•á‡§ü/‡§ó‡•ç‡§∞‡•Å‡§™ ‡§ï‡•á ‡§≤‡§ø‡§è -100‚Ä¶</label>
          <input id="tgIds" class="mt-1 w-full rounded-xl border px-4 py-3" />
          <p class="text-xs text-slate-500 mt-1">‡§â‡§¶‡§æ: <code>733804072</code> ‡§Ø‡§æ <code>@BJPBLOODREQUEST</code> ‡§Ø‡§æ ‡§¶‡•ã‡§®‡•ã‡§Ç: <code>733804072,@BJPBLOODREQUEST</code></p>
        </div>
        <div class="flex gap-2">
          <button id="btnSaveTg" class="px-4 py-3 rounded-xl bg-saffron-700 text-white">Save IDs</button>
          <button id="btnSendTest" class="px-4 py-3 rounded-xl bg-slate-900 text-white">Send</button>
        </div>
      </div>
      <p id="tgStatus" class="text-xs text-slate-600 mt-2"></p>
    </div>

    <!-- Donation Logger -->
    <div id="adminArea" class="hidden space-y-4">
      <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-sm border">
        <h3 class="text-base font-semibold mb-3">‡§¶‡§æ‡§® ‡§≤‡•â‡§ó ‡§ï‡§∞‡•á‡§Ç</h3>
        <div class="grid gap-3 sm:grid-cols-2">
          <div>
            <label class="text-sm text-slate-600">‡§°‡•ã‡§®‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç</label>
            <select id="selDonor" class="mt-1 w-full rounded-xl border px-4 py-3"></select>
            <p id="selDonorInfo" class="text-xs text-slate-500 mt-1"></p>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-sm text-slate-600">‡§Ø‡•Ç‡§®‡§ø‡§ü</label>
              <input type="number" min="1" id="d_units" class="mt-1 w-full rounded-xl border px-4 py-3" value="1" />
            </div>
            <div>
              <label class="text-sm text-slate-600">‡§§‡§æ‡§∞‡•Ä‡§ñ‡§º</label>
              <input type="date" id="d_date" class="mt-1 w-full rounded-xl border px-4 py-3" />
            </div>
          </div>
          <div>
            <label class="text-sm text-slate-600">‡§∞‡•ã‡§ó‡•Ä ‡§ï‡§æ ‡§®‡§æ‡§Æ</label>
            <input id="d_recipient" class="mt-1 w-full rounded-xl border px-4 py-3" placeholder="‡§ï‡§ø‡§∏‡§ï‡•ã ‡§¶‡§ø‡§Ø‡§æ?" />
          </div>
          <div>
            <label class="text-sm text-slate-600">‡§∞‡•ã‡§ó‡•Ä ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤</label>
            <input id="d_recipient_phone" class="mt-1 w-full rounded-xl border px-4 py-3" placeholder="optional" />
          </div>
          <div>
            <label class="text-sm text-slate-600">‡§Ö‡§∏‡•ç‡§™‡§§‡§æ‡§≤/‡§∏‡•ç‡§•‡§æ‡§®</label>
            <input id="d_hospital" class="mt-1 w-full rounded-xl border px-4 py-3" placeholder="‡§ú‡•à‡§∏‡•á: ‡§ú‡§ø‡§≤‡§æ ‡§Ö‡§∏‡•ç‡§™‡§§‡§æ‡§≤" />
          </div>
          <div class="sm:col-span-2">
            <label class="text-sm text-slate-600">‡§®‡•ã‡§ü‡•ç‡§∏</label>
            <textarea id="d_notes" class="mt-1 w-full rounded-xl border px-4 py-3" rows="2"></textarea>
          </div>
          <div class="sm:col-span-2 flex items-center gap-3">
            <button id="btnSaveDonation" class="px-4 py-3 rounded-xl bg-saffron-700 text-white font-semibold">‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç</button>
            <button id="btnExportDonors" class="px-4 py-3 rounded-xl bg-slate-900 text-white">Export Donors CSV</button>
            <button id="btnExportDonations" class="px-4 py-3 rounded-xl bg-slate-900 text-white">Export Donations CSV</button>
          </div>
        </div>
      </div>

      <!-- Donor List with filters + count + pagination -->
      <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-sm border">
        <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
          <div>
            <h3 class="text-base font-semibold">‡§°‡•ã‡§®‡§∞ ‡§∏‡•Ç‡§ö‡•Ä (‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞ ‡§∏‡§π‡§ø‡§§)</h3>
            <p class="text-sm text-slate-600">‡§ï‡•Å‡§≤: <b id="countAll">0</b> ‚Ä¢ ‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞ ‡§ï‡•á ‡§¨‡§æ‡§¶: <b id="countFiltered">0</b></p>
          </div>
          <div class="flex items-center gap-2 text-sm">
            <span>‡§™‡•á‡§ú:</span>
            <button id="pgPrev" class="px-3 py-1 rounded bg-slate-100 border">‚Äπ</button>
            <span id="pgInfo">1/1</span>
            <button id="pgNext" class="px-3 py-1 rounded bg-slate-100 border">‚Ä∫</button>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mt-3">
          <input id="fText" class="rounded-xl border px-4 py-3 text-base" placeholder="‡§®‡§æ‡§Æ/‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤/‡§™‡§§‡§æ" />
          <select id="fGroup" class="rounded-xl border px-4 py-3 text-base"></select>
          <select id="fMandal" class="rounded-xl border px-4 py-3 text-base"></select>
          <select id="fWilling" class="rounded-xl border px-4 py-3 text-base">
            <option value="">‡§∏‡§≠‡•Ä</option>
            <option value="yes">‡§á‡§ö‡•ç‡§õ‡•Å‡§ï</option>
            <option value="no">‡§Ö‡§®‡§ø‡§ö‡•ç‡§õ‡•Å‡§ï</option>
          </select>
        </div>

        <div class="mt-3 overflow-x-auto -mx-2 sm:mx-0">
          <table class="min-w-[980px] w-full text-sm">
            <thead>
              <tr class="bg-slate-100 text-slate-700">
                <th class="p-2 text-left">‡§®‡§æ‡§Æ</th>
                <th class="p-2 text-left">‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤</th>
                <th class="p-2 text-left">‡§¨‡•ç‡§≤‡§°</th>
                <th class="p-2 text-left">‡§Æ‡§Ç‡§°‡§≤</th>
                <th class="p-2 text-left">‡§™‡§§‡§æ</th>
                <th class="p-2 text-left">‡§Ü‡§ñ‡§º‡§ø‡§∞‡•Ä ‡§¶‡§æ‡§®</th>
                <th class="p-2 text-left">‡§á‡§ö‡•ç‡§õ‡§æ</th>
                <th class="p-2 text-left">‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ</th>
              </tr>
            </thead>
            <tbody id="donorsTbody"></tbody>
          </table>
        </div>
      </div>

      <!-- Charts -->
      <div class="grid md:grid-cols-2 gap-4">
        <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-sm border">
          <h3 class="text-base font-semibold mb-3">‡§¨‡•ç‡§≤‡§° ‡§ó‡•ç‡§∞‡•Å‡§™ ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§°‡•ã‡§®‡§∞</h3>
          <div class="h-64"><canvas id="chartGroups"></canvas></div>
        </div>
        <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-sm border">
          <h3 class="text-base font-semibold mb-3">‡§Æ‡§Ç‡§°‡§≤ ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§°‡•ã‡§®‡§∞</h3>
          <div class="h-64"><canvas id="chartMandals"></canvas></div>
        </div>
      </div>

      <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-sm border">
        <h3 class="text-base font-semibold mb-3">‡§Æ‡§æ‡§π‡§µ‡§æ‡§∞ ‡§∞‡§ï‡•ç‡§§‡§¶‡§æ‡§® (‡§Ø‡•Ç‡§®‡§ø‡§ü)</h3>
        <div class="h-64"><canvas id="chartMonthly"></canvas></div>
      </div>

      <!-- Recent Donations -->
      <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-sm border overflow-x-auto -mx-2 sm:mx-0">
        <h3 class="text-base font-semibold mb-3">Recent Donations</h3>
        <table class="min-w-[720px] w-full text-sm">
          <thead>
            <tr class="bg-slate-100 text-slate-700">
              <th class="p-2 text-left">‡§§‡§æ‡§∞‡•Ä‡§ñ‡§º</th>
              <th class="p-2 text-left">‡§°‡•ã‡§®‡§∞</th>
              <th class="p-2 text-left">‡§¨‡•ç‡§≤‡§°</th>
              <th class="p-2 text-left">‡§Æ‡§Ç‡§°‡§≤</th>
              <th class="p-2 text-left">‡§Ø‡•Ç‡§®‡§ø‡§ü</th>
              <th class="p-2 text-left">‡§ï‡§ø‡§∏‡§ï‡•ã</th>
              <th class="p-2 text-left">‡§Ö‡§∏‡•ç‡§™‡§§‡§æ‡§≤</th>
            </tr>
          </thead>
          <tbody id="donationsTbody"></tbody>
        </table>
      </div>

      <!-- Requests -->
      <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-sm border overflow-x-auto -mx-2 sm:mx-0">
        <h3 class="text-base font-semibold mb-3">Requests (‡§∞‡§ï‡•ç‡§§ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ)</h3>
        <table class="min-w-[720px] w-full text-sm">
          <thead>
            <tr class="bg-slate-100 text-slate-700">
              <th class="p-2 text-left">‡§§‡§æ‡§∞‡•Ä‡§ñ‡§º</th>
              <th class="p-2 text-left">‡§®‡§æ‡§Æ/‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤</th>
              <th class="p-2 text-left">‡§∞‡•ã‡§ó‡•Ä</th>
              <th class="p-2 text-left">‡§ó‡•ç‡§∞‡•Å‡§™/‡§Ø‡•Ç‡§®‡§ø‡§ü</th>
              <th class="p-2 text-left">‡§∏‡•ç‡§•‡§æ‡§®</th>
              <th class="p-2 text-left">‡§Ö‡§∏‡•ç‡§™‡§§‡§æ‡§≤/‡§®‡•ã‡§ü‡•ç‡§∏</th>
            </tr>
          </thead>
          <tbody id="reqTbody"></tbody>
        </table>
      </div>
    </div>
  </main>

  <footer class="max-w-6xl mx-auto p-4 text-xs text-slate-500 text-center">¬© <span id="year"></span> ‡§≠‡§æ‡§∞‡§§‡•Ä‡§Ø ‡§ú‡§®‡§§‡§æ ‡§™‡§æ‡§∞‡•ç‡§ü‡•Ä ‚Ä¢ ‡§ú‡§ø‡§≤‡§æ ‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞</footer>

  <!-- Edit Donor Modal -->
  <div id="editModal" class="modal fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="bg-white w-[92%] max-w-2xl rounded-2xl p-5">
      <h3 class="text-lg font-semibold">‡§°‡•ã‡§®‡§∞ ‡§∏‡§Ç‡§™‡§æ‡§¶‡§®</h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-3">
        <input id="ed_name" class="rounded-xl border px-4 py-3" placeholder="‡§®‡§æ‡§Æ">
        <input id="ed_phone" class="rounded-xl border px-4 py-3" placeholder="‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤">
        <input id="ed_whatsapp" class="rounded-xl border px-4 py-3" placeholder="‡§µ‡•ç‡§π‡§æ‡§ü‡•ç‡§∏‡§ê‡§™">
        <select id="ed_group" class="rounded-xl border px-4 py-3"></select>
        <select id="ed_mandal" class="rounded-xl border px-4 py-3"></select>
        <input id="ed_address" class="rounded-xl border px-4 py-3" placeholder="‡§µ‡§æ‡§∞‡•ç‡§°/‡§¨‡•Ç‡§•/‡§™‡§§‡§æ">
        <input id="ed_age" type="number" class="rounded-xl border px-4 py-3" placeholder="‡§â‡§Æ‡•ç‡§∞">
        <select id="ed_gender" class="rounded-xl border px-4 py-3">
          <option value="">‡§≤‡§ø‡§Ç‡§ó</option><option>‡§™‡•Å‡§∞‡•Å‡§∑</option><option>‡§Æ‡§π‡§ø‡§≤‡§æ</option><option>‡§Ö‡§®‡•ç‡§Ø</option>
        </select>
        <input id="ed_last" type="date" class="rounded-xl border px-4 py-3">
        <select id="ed_willing" class="rounded-xl border px-4 py-3">
          <option value="yes">‡§á‡§ö‡•ç‡§õ‡•Å‡§ï</option><option value="no">‡§Ö‡§®‡§ø‡§ö‡•ç‡§õ‡•Å‡§ï</option>
        </select>
        <textarea id="ed_notes" class="sm:col-span-2 rounded-xl border px-4 py-3" rows="2" placeholder="‡§®‡•ã‡§ü‡•ç‡§∏"></textarea>
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button id="btnEdCancel" class="px-4 py-2 rounded-xl border">‡§∞‡§¶‡•ç‡§¶</button>
        <button id="btnEdSave" class="px-4 py-2 rounded-xl bg-saffron-700 text-white">‡§∏‡•á‡§µ</button>
      </div>
    </div>
  </div>

  <script>
    const BLOOD_GROUPS = ["A+","A-","B+","B-","O+","O-","AB+","AB-"];
    const MANDALS = ["‡§Ö‡§®‡•ç‡§Ø","‡§≠‡•á‡§Ç‡§∏‡•ã‡§¶‡§æ","‡§≠‡§æ‡§®‡§™‡•Å‡§∞‡§æ","‡§ó‡§∞‡•ã‡§†","‡§Æ‡•á‡§≤‡§ñ‡•á‡§°‡§æ","‡§ñ‡•ú‡§æ‡§µ‡§¶‡§æ","‡§∂‡§æ‡§Æ‡§ó‡•ù","‡§∏‡•Å‡§µ‡§æ‡§∏‡§∞‡§æ","‡§¨‡§∏‡§æ‡§à","‡§∏‡•Ä‡§§‡§æ‡§Æ‡§ä","‡§ï‡•ç‡§Ø‡§æ‡§Æ‡§™‡•Å‡§∞","‡§∏‡•Ä‡§§‡§æ‡§Æ‡§ä ‡§ó‡•ç‡§∞‡§æ‡§Æ‡•Ä‡§£","‡§ó‡•Å‡§∞‡•ç‡§ú‡§∞ ‡§¨‡§∞‡§°‡§ø‡§Ø‡§æ","‡§ß‡•Å‡§Ç‡§ß‡§ß‡•ú‡§ï‡§æ","‡§¨‡•Å‡§¢‡§æ","‡§™‡§ø‡§™‡§≤‡§ø‡§Ø‡§æ ‡§Æ‡§Ç‡§°‡•Ä","‡§Æ‡§≤‡•ç‡§π‡§æ‡§∞‡§ó‡•ù","‡§¶‡§≤‡•ã‡§¶‡§æ","‡§Æ‡§ó‡§∞‡§æ‡§Æ‡§æ‡§§‡§æ ‡§ú‡•Ä","‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞ ‡§ó‡•ç‡§∞‡§æ‡§Æ‡•Ä‡§£","‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞ ‡§â‡§§‡•ç‡§§‡§∞","‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞ ‡§¶‡§ï‡•ç‡§∑‡§ø‡§£","‡§Ö‡§®‡•ç‡§Ø ‡§ú‡§ø‡§≤‡•á ‡§∏‡•á"];
    const $ = (id)=>document.getElementById(id);
    document.getElementById('year').textContent = new Date().getFullYear();
    const fmtTS = (ts)=>{ try{ const d = ts?.toDate? ts.toDate(): new Date(ts); return d.toLocaleDateString('en-GB'); }catch{ return '' } };
    const fill = (el, arr, first)=>{ el.innerHTML=''; if(first) el.insertAdjacentHTML('beforeend', `<option value="">${first}</option>`); arr.forEach(x=> el.insertAdjacentHTML('beforeend', `<option value="${x}">${x}</option>`)); }

    // Telegram config (token + default DM id)
    const TELEGRAM_BOT_TOKEN = "8462350268:AAH2Za886P4VPrLbLWa-RcxL0pbRNwwIfKQ";
    let TELEGRAM_CHAT_IDS = (localStorage.getItem('tgIds') || '733804072').split(',').map(x=>x.trim()).filter(Boolean);

    function showToast(txt, ok=true){
      const t=$('toast');
      t.className='toast';
      t.innerHTML=`<div class="mx-auto max-w-lg bg-white border rounded-2xl shadow px-4 py-3 ${ok?'border-green-600':'border-red-600'}"><div class="text-sm ${ok?'text-green-700':'text-red-700'}">${txt}</div></div>`;
      setTimeout(()=>t.classList.add('hidden'), 3500);
    }
  </script>

  <script type="module">
    const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js');
    const { getFirestore, collection, onSnapshot, query, orderBy, addDoc, updateDoc, deleteDoc, doc, serverTimestamp } =
      await import('https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js');

    const firebaseConfig = {
      apiKey: "AIzaSyA9LZaQJkAqr9F1YEFfRxa4aGiwvFevs9c",
      authDomain: "blodddonation-9c44e.firebaseapp.com",
      projectId: "blodddonation-9c44e",
      storageBucket: "blodddonation-9c44e.firebasestorage.app",
      messagingSenderId: "636578091772",
      appId: "1:636578091772:web:276d08168f8fc9c221fd79",
      measurementId: "G-3TPG0JCF3R"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ---- Admin gate (UI) ----
    let adminOK = false;
    $('btnUnlock').onclick = () => {
      const pin = ($('adminPin').value || '').trim();
      if(pin === '2720'){
        adminOK = true;
        $('adminGate').classList.add('hidden');
        $('adminOk').classList.remove('hidden');
        $('adminArea').classList.remove('hidden');
      } else alert('‡§ó‡§≤‡§§ PIN');
    };

    // ---- Telegram UI ----
    const tgInput = $('tgIds');
    tgInput.value = (localStorage.getItem('tgIds') || '733804072');
    $('btnSaveTg').onclick = ()=>{
      localStorage.setItem('tgIds', tgInput.value.trim());
      TELEGRAM_CHAT_IDS = tgInput.value.split(',').map(x=>x.trim()).filter(Boolean);
      $('tgStatus').textContent = 'IDs ‡§∏‡•á‡§µ ‡§π‡•ã ‡§ó‡§à‡§Ç ‚úÖ';
    };
    $('btnSendTest').onclick = ()=> sendTelegram(`Test ‚úÖ ${new Date().toLocaleString()}`);

    async function sendTelegram(text){
      const ids = TELEGRAM_CHAT_IDS && TELEGRAM_CHAT_IDS.length ? TELEGRAM_CHAT_IDS : ['733804072'];
      $('tgStatus').textContent = '‡§≠‡•á‡§ú‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à‚Ä¶';
      try{
        // 1) Netlify function (recommended)
        let ok = true;
        for (const id of ids) {
          const r = await fetch('/.netlify/functions/send-tg', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ chat_id: id, text })
          });
          ok = ok && r.ok;
        }
        if (ok) { $('tgStatus').textContent = '‡§≠‡•á‡§ú ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‚úÖ'; return; }
      }catch(e){ /* ignore & fallback */ }

      try{
        // 2) Direct Telegram API (if allowed by network)
        for (const id of ids) {
          await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`,{
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ chat_id:id, text })
          });
        }
        $('tgStatus').textContent = '‡§≠‡•á‡§ú ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‚úÖ';
      }catch(e){
        // 3) CORS-safe pixel fallback
        for (const id of TELEGRAM_CHAT_IDS) {
          const img = new Image();
          img.src = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage?chat_id=${encodeURIComponent(id)}&text=${encodeURIComponent(text)}`;
        }
        $('tgStatus').textContent = '‡§≠‡•á‡§ú‡§®‡•á ‡§ï‡•Ä ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡•Ä ‡§ó‡§à (fallback) ‚ö†Ô∏è';
      }
    }

    // ---- Data state ----
    let donors = []; let donations = []; let requests = [];
    const donorsTbody = $('donorsTbody');
    const sel = $('selDonor');

    onSnapshot(query(collection(db,'donors'), orderBy('createdAt','desc')), snap=>{
      donors = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      renderAdminDonorSelect();
      renderDonorTable();
      updateCharts();
    });
    onSnapshot(query(collection(db,'donations'), orderBy('date','desc')), snap=>{
      donations = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      renderDonationsTable();
      updateCharts();
    });
    onSnapshot(query(collection(db,'requests'), orderBy('createdAt','desc')), snap=>{
      requests = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      renderRequestsTable();
    });

    function renderAdminDonorSelect(){
      sel.innerHTML = '<option value="">‚Äî</option>';
      donors.forEach(d=> sel.insertAdjacentHTML('beforeend', `<option value="${d.id}">${d.name||''} ‚Ä¢ ${d.bloodGroup||''} ‚Ä¢ ${d.mandal||''}</option>`));
      sel.onchange = ()=>{ const d = donors.find(x=>x.id===sel.value); $('selDonorInfo').textContent = d ? `‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤: ${d.phone||''} ‚Ä¢ ‡§Ü‡§ñ‡§º‡§ø‡§∞‡•Ä ‡§¶‡§æ‡§®: ${d.lastDonationDate?fmtTS(d.lastDonationDate):'‚Äî'}` : ''; };
    }

    // Filters + pagination
    const fText=$('fText'), fGroup=$('fGroup'), fMandal=$('fMandal'), fWilling=$('fWilling');
    fill(fGroup, BLOOD_GROUPS, '‡§¨‡•ç‡§≤‡§° ‡§ó‡•ç‡§∞‡•Å‡§™'); fill(fMandal, MANDALS, '‡§Æ‡§Ç‡§°‡§≤');
    [fText,fGroup,fMandal,fWilling].forEach(el=> el.addEventListener('input', renderDonorTable));
    let page=1, perPage=100;
    $('pgPrev').onclick=()=>{ if(page>1){ page--; renderDonorTable(); } };
    $('pgNext').onclick=()=>{ page++; renderDonorTable(); };

    function applyFilters(){
      const t=(fText.value||'').toLowerCase(), g=fGroup.value, m=fMandal.value, w=fWilling.value;
      return donors.filter(d=>{
        const okText = !t || [d.name,d.phone,d.address].some(v=> (v||'').toLowerCase().includes(t));
        const okG = !g || d.bloodGroup===g;
        const okM = !m || d.mandal===m;
        const will = (d.willing===true || (typeof d.willing==='string' && d.willing.toLowerCase()==='yes'));
        const okW = !w || (w==='yes'? will : !will);
        return okText && okG && okM && okW;
      });
    }

    function renderDonorTable(){
      const rows = applyFilters();
      $('countAll').textContent = donors.length;
      $('countFiltered').textContent = rows.length;

      const totalPages = Math.max(1, Math.ceil(rows.length/perPage));
      if(page>totalPages) page = totalPages;
      $('pgInfo').textContent = `${page}/${totalPages}`;
      const slice = rows.slice((page-1)*perPage, page*perPage);

      donorsTbody.innerHTML='';
      slice.forEach(d=> donorsTbody.insertAdjacentHTML('beforeend', `
        <tr class="odd:bg-white even:bg-slate-50">
          <td class="p-2 font-medium">${d.name||''}</td>
          <td class="p-2"><a class="underline" href="tel:${d.phone||''}">${d.phone||''}</a></td>
          <td class="p-2">${d.bloodGroup||''}</td>
          <td class="p-2">${d.mandal||''}</td>
          <td class="p-2">${d.address||''}</td>
          <td class="p-2">${d.lastDonationDate?fmtTS(d.lastDonationDate):'‚Äî'}</td>
          <td class="p-2">${(d.willing===false || (typeof d.willing==='string' && d.willing.toLowerCase()==='no'))?'‡§®‡§π‡•Ä‡§Ç':'‡§π‡§æ‡§Å'}</td>
          <td class="p-2">
            <button class="text-blue-700 underline" data-act="edit" data-id="${d.id}">Edit</button>
            <span class="mx-1">‚Ä¢</span>
            <button class="text-red-700 underline" data-act="del" data-id="${d.id}">Delete</button>
          </td>
        </tr>`));

      // row actions
      donorsTbody.querySelectorAll('button[data-act="del"]').forEach(btn=>{
        btn.onclick = async ()=>{
          if(!adminOK) return alert('Admin ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï');
          const id = btn.dataset.id;
          if(!confirm('‡§°‡•ã‡§®‡§∞ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡•á‡§Ç?')) return;
          try{
            await deleteDoc(doc(db,'donors', id));
            showToast('‡§°‡•ã‡§®‡§∞ ‡§π‡§ü‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ', true);
          }catch(e){ console.error(e); alert('Firestore ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø/‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ' + (e?.message||e)); }
        };
      });
      donorsTbody.querySelectorAll('button[data-act="edit"]').forEach(btn=>{
        btn.onclick = ()=> openEditModal(btn.dataset.id);
      });
    }

    // Edit modal
    fill($('ed_group'), BLOOD_GROUPS, '‡§¨‡•ç‡§≤‡§° ‡§ó‡•ç‡§∞‡•Å‡§™'); fill($('ed_mandal'), MANDALS, '‡§Æ‡§Ç‡§°‡§≤');
    $('btnEdCancel').onclick = ()=> toggleEdit(false);
    let editingId=null;
    function openEditModal(id){
      const d = donors.find(x=>x.id===id); if(!d) return;
      editingId = id;
      $('ed_name').value = d.name||''; $('ed_phone').value = d.phone||''; $('ed_whatsapp').value = d.whatsapp||'';
      $('ed_group').value = d.bloodGroup||''; $('ed_mandal').value = d.mandal||'';
      $('ed_address').value = d.address||''; $('ed_age').value = d.age||'';
      $('ed_gender').value = d.gender||''; $('ed_notes').value = d.notes||'';
      $('ed_last').value = d.lastDonationDate ? new Date(d.lastDonationDate.toDate ? d.lastDonationDate.toDate() : d.lastDonationDate).toISOString().slice(0,10) : '';
      $('ed_willing').value = (d.willing===false || (typeof d.willing==='string' && d.willing.toLowerCase()==='no'))?'no':'yes';
      toggleEdit(true);
    }
    function toggleEdit(show){
      const m = $('editModal'); if(show){ m.classList.remove('hidden'); m.classList.add('flex'); } else { m.classList.add('hidden'); m.classList.remove('flex'); }
    }
    $('btnEdSave').onclick = async ()=>{
      if(!adminOK) return alert('Admin ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï');
      if(!editingId) return;
      try{
        const payload = {
          name:$('ed_name').value.trim(),
          phone:$('ed_phone').value.trim(),
          whatsapp:$('ed_whatsapp').value.trim(),
          bloodGroup:$('ed_group').value,
          mandal:$('ed_mandal').value,
          address:$('ed_address').value.trim(),
          age: $('ed_age').value? Number($('ed_age').value): null,
          gender:$('ed_gender').value,
          notes:$('ed_notes').value.trim(),
          willing: $('ed_willing').value==='yes',
          lastDonationDate: $('ed_last').value ? new Date($('ed_last').value) : null
        };
        await updateDoc(doc(db,'donors', editingId), payload);
        toggleEdit(false);
        showToast('‡§°‡•ã‡§®‡§∞ ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•Å‡§Ü', true);
      }catch(e){ console.error(e); alert('Firestore ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø/‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ' + (e?.message||e)); }
    };

    // Save donation
    $('btnSaveDonation').onclick = async ()=>{
      if(!adminOK) return alert('Admin ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï');
      const id = sel.value; const d = donors.find(x=>x.id===id); if(!d) return alert('‡§°‡•ã‡§®‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç');
      const payload = {
        donorId: d.id, donorName: d.name, donorPhone: d.phone,
        mandal: d.mandal, bloodGroup: d.bloodGroup,
        recipientName: $('d_recipient').value.trim(),
        recipientPhone: $('d_recipient_phone').value.trim(),
        units: Number($('d_units').value||1),
        hospital: $('d_hospital').value.trim(),
        date: $('d_date').value ? new Date($('d_date').value) : new Date(),
        notes: $('d_notes').value.trim(),
        createdAt: serverTimestamp(),
      };
      await addDoc(collection(db,'donations'), payload);
      await updateDoc(doc(db,'donors', d.id), { lastDonationDate: payload.date });
      alert('‡§¶‡§æ‡§® ‡§™‡•ç‡§∞‡§µ‡§ø‡§∑‡•ç‡§ü‡§ø ‡§∏‡•á‡§µ ‡§π‡•ã ‡§ó‡§Ø‡§æ‡•§');
      ["d_recipient","d_recipient_phone","d_units","d_hospital","d_date","d_notes"].forEach(i=> $(i).value=''); $('d_units').value='1';
    };

    // Export CSV
    $('btnExportDonors').onclick = ()=>{
      const header = ['name','phone','whatsapp','bloodGroup','mandal','address','age','gender','lastDonationDate','willing','createdAt'];
      const rows = donors.map(d=> ([
        d.name||'', d.phone||'', d.whatsapp||'', d.bloodGroup||'', d.mandal||'', (d.address||'').replace(/\n/g,' '),
        d.age||'', d.gender||'', (d.lastDonationDate?fmtTS(d.lastDonationDate):''), (d.willing===false?'no':'yes'), (d.createdAt?fmtTS(d.createdAt):'')
      ]));
      downloadCSV('donors.csv', [header, ...rows]);
    };
    $('btnExportDonations').onclick = ()=>{
      const header = ['date','donorName','donorPhone','bloodGroup','mandal','units','recipientName','recipientPhone','hospital'];
      const rows = donations.map(x=> ([
        (x.date?fmtTS(x.date):''), x.donorName||'', x.donorPhone||'', x.bloodGroup||'', x.mandal||'', x.units||'',
        x.recipientName||'', x.recipientPhone||'', (x.hospital||'').replace(/\n/g,' ')
      ]));
      downloadCSV('donations.csv', [header, ...rows]);
    };
    function downloadCSV(filename, rows){
      const esc = (v)=> '"'+String(v).replaceAll('"','""')+'"';
      const csv = rows.map(r=> r.map(esc).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // Charts
    let chartGroups, chartMandals, chartMonthly;
    function updateCharts(){
      const groups = BLOOD_GROUPS.map(g=>({label:g, count: donors.filter(d=>d.bloodGroup===g).length}));
      const mandalMap = new Map(); donors.forEach(d=>{ const k=d.mandal||'‡§Ö‡§®‡§ø‡§∞‡•ç‡§¶‡§ø‡§∑‡•ç‡§ü'; mandalMap.set(k,(mandalMap.get(k)||0)+1) });
      const mandalsSorted = Array.from(mandalMap.entries()).sort((a,b)=>b[1]-a[1]);
      const monthMap = new Map();
      donations.forEach(x=>{ const dt = x.date && x.date.toDate ? x.date.toDate() : new Date(x.date); const k = dt.getFullYear()+"-"+String(dt.getMonth()+1).padStart(2,'0'); monthMap.set(k,(monthMap.get(k)||0)+(Number(x.units)||1)); });
      const months = Array.from(monthMap.entries()).sort((a,b)=> a[0].localeCompare(b[0]));

      const cfgBar = (labels, data)=>({ type:'bar', data:{ labels, datasets:[{ label:'‡§ï‡•Å‡§≤', data }] }, options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ ticks:{ precision:0 }}}}});
      const cfgLine = (labels, data)=>({ type:'line', data:{ labels, datasets:[{ label:'‡§Ø‡•Ç‡§®‡§ø‡§ü', data, tension:0.3 }] }, options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ ticks:{ precision:0 }}}}});

      const gEl = document.getElementById('chartGroups'); if(chartGroups) chartGroups.destroy(); chartGroups = new Chart(gEl, cfgBar(groups.map(x=>x.label), groups.map(x=>x.count)));
      const mEl = document.getElementById('chartMandals'); if(chartMandals) chartMandals.destroy(); chartMandals = new Chart(mEl, cfgBar(mandalsSorted.map(x=>x[0]), mandalsSorted.map(x=>x[1])));
      const moEl = document.getElementById('chartMonthly'); if(chartMonthly) chartMonthly.destroy(); chartMonthly = new Chart(moEl, cfgLine(months.map(x=>x[0]), months.map(x=>x[1])));
    }

    function renderDonationsTable(){
      const tb = $('donationsTbody'); tb.innerHTML='';
      donations.forEach(x=> tb.insertAdjacentHTML('beforeend', `
        <tr class="odd:bg-white even:bg-slate-50">
          <td class="p-2">${x.date?fmtTS(x.date):'‚Äî'}</td>
          <td class="p-2 font-medium">${x.donorName||'-'} <span class="text-slate-400">(${x.donorPhone||''})</span></td>
          <td class="p-2">${x.bloodGroup||''}</td>
          <td class="p-2">${x.mandal||''}</td>
          <td class="p-2">${x.units||''}</td>
          <td class="p-2">${x.recipientName||'‚Äî'}</td>
          <td class="p-2">${x.hospital||'‚Äî'}</td>
        </tr>`));
    }

    function renderRequestsTable(){
      const tb = $('reqTbody'); tb.innerHTML='';
      requests.forEach(r=> tb.insertAdjacentHTML('beforeend', `
        <tr class="odd:bg-white even:bg-slate-50">
          <td class="p-2">${r.createdAt?fmtTS(r.createdAt):'‚Äî'}</td>
          <td class="p-2 font-medium">${r.requester||'-'} <span class="text-slate-400">(${r.phone||''})</span></td>
          <td class="p-2">${r.patient||'-'}</td>
          <td class="p-2">${r.bloodGroup||'-'} / ${r.units||'-'}</td>
          <td class="p-2">${r.location||'-'}</td>
          <td class="p-2">${r.hospital||'-'}</td>
        </tr>`));
    }
  </script>
</body>
</html>
