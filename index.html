<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>рдбреЛрдирд░ рдЦреЛрдЬ тАв рд░рдХреНрддрджрд╛рддрд╛ рдкреЛрд░реНрдЯрд▓</title>

  <!-- Tailwind + Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { devanagari: ['"Noto Sans Devanagari"', 'system-ui', 'sans-serif'] },
          colors: {
            saffron: { 50:'#FFF4E8',100:'#FFE8D6',200:'#FFD7B3',300:'#FFC48A',400:'#FFA24D',500:'#FF7F0E',600:'#E06900',700:'#C25700',800:'#A34500',900:'#873800' },
            peach: { 50:'#FFF7EF',100:'#FFEFE0',200:'#FFE3C6' }
          }
        }
      }
    }
  </script>
  <style>
    body { font-family: "Noto Sans Devanagari", system-ui, sans-serif; }
    .toast { position: fixed; inset-inline: 0; top: 10px; margin-inline: auto; width: fit-content; z-index: 50; }
    .modal{ transition:opacity .2s ease }
  </style>
</head>
<body class="min-h-screen bg-peach-50">
  <div id="toast" class="toast hidden"></div>

<header class="bg-gradient-to-r from-orange-500 via-red-500 to-rose-600 text-white shadow-xl">
  <div class="max-w-6xl mx-auto px-4 py-6 text-center">
    <h1 class="text-3xl sm:text-5xl font-extrabold drop-shadow-lg">
      рднрд╛рд░рддреАрдп рдЬрдирддрд╛ рдкрд╛рд░реНрдЯреА рдЬрд┐рд▓рд╛ рдордВрджрд╕реМрд░
    </h1>
  </div>
</header>



  <main class="max-w-6xl mx-auto p-4 space-y-4">
    <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-sm border text-center">
        <h2 class="text-3xl sm:text-5xl font-extrabold text-red-700 leading-tight">рд░рдХреНрддрджрд╛рддрд╛ рдкреЛрд░реНрдЯрд▓</h2>
         <p class="mt-3 text-slate-700 text-base sm:text-lg max-w-3xl mx-auto">
             рдорд╛рдирдиреАрдп рдкреНрд░рдзрд╛рдирдордВрддреНрд░реА рд╢реНрд░реА рдирд░реЗрдВрджреНрд░ рдореЛрджреА рдЬреА рдХреЗ рдЬрдиреНрдо рджрд┐рд╡рд╕ <b>17 рд╕рд┐рддрдореНрдмрд░</b> рдХреЗ рдЕрд╡рд╕рд░ рдкрд░, рдпрд╣ рдкреЛрд░реНрдЯрд▓ рдЖрдо рдирд╛рдЧрд░рд┐рдХреЛрдВ рдХреА рд╕реЗрд╡рд╛ рдореЗрдВ рд╕рдорд░реНрдкрд┐рдд рд╣реИред
        </p>
        <div class="mt-4">
          <a href="register.html" class="px-6 py-3 rounded-xl bg-orange-500 text-white font-semibold hover:bg-orange-600 transition-colors inline-block">
            рд░рдХреНрддрджрд╛рддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рд░рдЬрд┐рд╕реНрдЯрд░ рдХрд░реЗрдВ
          </a>
        </div>
    </div>


    <!-- Search -->
    <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-sm border">
      <div class="flex items-center justify-between gap-2 flex-wrap">
        <h2 class="text-lg font-semibold">рдбреЛрдирд░ рдЦреЛрдЬреЗрдВ</h2>
        <div id="resultInfo" class="text-sm text-slate-500"></div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
        <input id="qText" class="rounded-xl border px-4 py-3 text-base" placeholder="рдирд╛рдо/рдореЛрдмрд╛рдЗрд▓/рдкрддрд╛" />
        <select id="qGroup" class="rounded-xl border px-4 py-3 text-base"></select>
        <select id="qMandal" class="rounded-xl border px-4 py-3 text-base"></select>
      </div>
      
      <p class="mt-3 text-xs sm:text-sm text-slate-600">
        рд░рдХреНрддрджрд╛рддрд╛рдУрдВ рдХреА рдЧреЛрдкрдиреАрдпрддрд╛ рд╣реЗрддреБ рдХреЗрд╡рд▓ 3 рдкрд░рд┐рдгрд╛рдо рджрд┐рдЦрд╛рдП рдЧрдП рд╣реИрдВред рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдпрд╛ рд░рдХреНрдд рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдХреЗ рд▓рд┐рдП рдиреАрдЪреЗ рджрд┐рдпрд╛ рдЧрдпрд╛ рдЕрдиреБрд░реЛрдз рдлреЙрд░реНрдо рднрд░реЗрдВред
      </p>

      <div id="cardGrid" class="mt-4 grid sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
    </div>

    <!-- Request -->
    <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-sm border">
      <h3 class="text-base font-semibold mb-3">рд░рдХреНрдд рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЗрддреБ рдЕрдиреБрд░реЛрдз</h3>
      <form id="reqForm" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div>
          <label class="text-sm text-slate-600">рдЖрдкрдХрд╛ рдирд╛рдо</label>
          <input id="r_requester" class="mt-1 w-full rounded-xl border px-4 py-3 text-base" required autocomplete="name" />
        </div>
        <div>
          <label class="text-sm text-slate-600">рдореЛрдмрд╛рдЗрд▓</label>
          <input id="r_phone" class="mt-1 w-full rounded-xl border px-4 py-3 text-base" pattern="[0-9]{10}" inputmode="numeric" autocomplete="tel" required />
        </div>
        <div>
          <label class="text-sm text-slate-600">рдЬрд░реВрд░рддрдордВрдж рдХрд╛ рдирд╛рдо</label>
          <input id="r_patient" class="mt-1 w-full rounded-xl border px-4 py-3 text-base" />
        </div>
        <div>
          <label class="text-sm text-slate-600">рдмреНрд▓рдб рдЧреНрд░реБрдк</label>
          <select id="r_group" class="mt-1 w-full rounded-xl border px-4 py-3 text-base" required></select>
        </div>
        <div>
          <label class="text-sm text-slate-600">рдпреВрдирд┐рдЯ</label>
          <input type="number" min="1" id="r_units" class="mt-1 w-full rounded-xl border px-4 py-3 text-base" value="1" />
        </div>
        <div>
          <label class="text-sm text-slate-600">рд╕реНрдерд╛рди</label>
          <input id="r_location" class="mt-1 w-full rounded-xl border px-4 py-3 text-base" placeholder="рд╡рд╛рд░реНрдб/рдПрд░рд┐рдпрд╛/рд╢рд╣рд░" />
        </div>
        <div class="sm:col-span-2">
          <label class="text-sm text-slate-600">рдЕрд╕реНрдкрддрд╛рд▓/рдиреЛрдЯреНрд╕</label>
          <textarea id="r_hospital" class="mt-1 w-full rounded-xl border px-4 py-3 text-base" rows="2" placeholder="рдЕрд╕реНрдкрддрд╛рд▓, рдбреЙрдХреНрдЯрд░, рдЕрдиреНрдп"></textarea>
        </div>
        <div class="sm:col-span-2 flex items-center gap-3">
          <button class="px-5 py-3 rounded-xl bg-orange-500 text-white font-semibold hover:bg-orange-600 transition-colors">рдЕрдиреБрд░реЛрдз рднреЗрдЬреЗрдВ</button>
          <span id="reqMsg" class="text-sm"></span>
        </div>
      </form>
    </div>
  </main>

  <footer class="max-w-6xl mx-auto p-4 text-xs text-slate-500 text-center">┬й <span id="year"></span> рднрд╛рд░рддреАрдп рдЬрдирддрд╛ рдкрд╛рд░реНрдЯреА тАв рдЬрд┐рд▓рд╛ рдордВрджрд╕реМрд░</footer>

  <!-- Success Modal -->
  <div id="reqOkModal" class="modal fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="bg-white w-[90%] max-w-md rounded-2xl p-6 text-center">
      <div class="text-2xl font-extrabold text-green-600">рдЕрдиреБрд░реЛрдз рдкреНрд░рд╛рдкреНрдд рд╣реБрдЖ!</div>
      <p class="mt-2 text-slate-700">рдЖрдкрдХреА рд░рд┐рдХреНрд╡реЗрд╕реНрдЯ рдкреНрд░рд╛рдкреНрдд рд╣реЛ рдЧрдпреА рд╣реИред рдЬрд┐рд▓рд╛ рднрд╛рдЬрдкрд╛ рдХрд╛рд░реНрдпрд╛рд▓рдп рд╕реЗ рдЬрд▓реНрдж рд╣реА рдХреЛрдИ рдЖрдкрд╕реЗ рд╕рдВрдкрд░реНрдХ рдХрд░реЗрдЧрд╛ред</p>
      <button id="reqOkClose" class="mt-4 px-5 py-2 rounded-xl bg-orange-500 text-white font-semibold">рдареАрдХ рд╣реИ</button>
    </div>
  </div>


  <script>
    const MANDALS = ["рдЕрдиреНрдп","рднреЗрдВрд╕реЛрджрд╛","рднрд╛рдирдкреБрд░рд╛","рдЧрд░реЛрда","рдореЗрд▓рдЦреЗрдбрд╛","рдЦреЬрд╛рд╡рджрд╛","рд╢рд╛рдордЧреЭ","рд╕реБрд╡рд╛рд╕рд░рд╛","рдмрд╕рд╛рдИ","рд╕реАрддрд╛рдордК","рдХреНрдпрд╛рдордкреБрд░","рд╕реАрддрд╛рдордК рдЧреНрд░рд╛рдореАрдг","рдЧреБрд░реНрдЬрд░ рдмрд░рдбрд┐рдпрд╛","рдзреБрдВрдзрдзреЬрдХрд╛","рдмреБрдврд╛","рдкрд┐рдкрд▓рд┐рдпрд╛ рдордВрдбреА","рдорд▓реНрд╣рд╛рд░рдЧреЭ","рджрд▓реЛрджрд╛","рдордЧрд░рд╛рдорд╛рддрд╛ рдЬреА","рдордВрджрд╕реМрд░ рдЧреНрд░рд╛рдореАрдг","рдордВрджрд╕реМрд░ рдЙрддреНрддрд░","рдордВрджрд╕реМрд░ рджрдХреНрд╖рд┐рдг","рдЕрдиреНрдп рдЬрд┐рд▓реЗ рд╕реЗ"];
    const BLOOD_GROUPS = ["A+","A-","B+","B-","O+","O-","AB+","AB-"];
    const $ = (id)=>document.getElementById(id);
    const fill = (el, arr, first)=>{ el.innerHTML=''; if(first) el.insertAdjacentHTML('beforeend', `<option value="">${first}</option>`); arr.forEach(x=> el.insertAdjacentHTML('beforeend', `<option value="${x}">${x}</option>`)); }
    document.getElementById('year').textContent = new Date().getFullYear();
    fill($('qGroup'), BLOOD_GROUPS, 'рдмреНрд▓рдб рдЧреНрд░реБрдк');
    fill($('qMandal'), MANDALS, 'рдордВрдбрд▓');
    fill($('r_group'), BLOOD_GROUPS, 'рдЪреБрдиреЗрдВ');

    const fmtTS = (ts)=>{ try{ const d = ts?.toDate? ts.toDate(): new Date(ts); return d.toLocaleDateString('en-GB'); }catch{ return '' } };
    const isWilling = (d)=>{ if(!d) return true; const w=d.willing; if(w===false) return false; if(typeof w==='string'){ const s=w.trim().toLowerCase(); if(['no','рдирд╣реАрдВ','nahi','nai'].includes(s)) return false; } return true; };

    const TELEGRAM_BOT_TOKEN = "8462350268:AAH2Za886P4VPrLbLWa-RcxL0pbRNwwIfKQ";
    const TELEGRAM_CHAT_ID   = "733804072";

    async function sendTelegram(text) {
      try {
        await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, text })
        });
      } catch(_) {}
    }

    function showToast(html, ok=true) {
      const t = document.getElementById('toast'); t.className = 'toast';
      t.innerHTML = `<div class="mx-auto max-w-lg bg-white border rounded-2xl shadow px-4 py-3 ${ok?'border-green-600':'border-red-600'}"><div class="text-sm ${ok?'text-green-700':'text-red-700'}">${html}</div></div>`;
      setTimeout(()=> t.classList.add('hidden'), 3500);
    }
  </script>

  <script type="module">
    const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js');
    const { getFirestore, collection, onSnapshot, query, orderBy, addDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js');

    const firebaseConfig = {
      apiKey: "AIzaSyA9LZaQJkAqr9F1YEFfRxa4aGiwvFevs9c",
      authDomain: "blodddonation-9c44e.firebaseapp.com",
      projectId: "blodddonation-9c44e",
      storageBucket: "blodddonation-9c44e.firebasestorage.app",
      messagingSenderId: "636578091772",
      appId: "1:636578091772:web:276d08168f8fc9c221fd79",
      measurementId: "G-3TPG0JCF3R"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let donors = [];

    onSnapshot(query(collection(db,'donors'), orderBy('createdAt','desc')), snap=>{
      donors = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      render();
    });

    ['qText','qGroup','qMandal'].forEach(id=> document.getElementById(id).addEventListener('input', render));

    function render(){
      const $ = (id)=>document.getElementById(id);
      const t = $('qText').value.trim().toLowerCase();
      const g = $('qGroup').value;
      const m = $('qMandal').value;
      
      const rowsAll = donors.filter(d=>{
        const okText = !t || [d.name,d.phone,d.address,d.city].some(v=> (v||'').toLowerCase().includes(t));
        const okG = !g || d.bloodGroup===g;
        const okM = !m || d.mandal===m;
        return okText && okG && okM && isWilling(d);
      });
      
      const shuffled = rowsAll.sort(() => 0.5 - Math.random());
      const rows = shuffled.slice(0, 3);

      $('resultInfo').textContent = rowsAll.length ? `${rows.length}/${rowsAll.length} рдкрд░рд┐рдгрд╛рдо рдкреНрд░рджрд░реНрд╢рд┐рдд` : 'рдХреЛрдИ рдкрд░рд┐рдгрд╛рдо рдирд╣реАрдВ';
      const grd = $('cardGrid'); grd.innerHTML='';
      rows.forEach(d=>{
        const waNum = (d.whatsapp || d.phone || '').replace(/\D/g,'');
        const msg = encodeURIComponent(`рдирдорд╕реНрдХрд╛рд░ ${d.name||''} рдЬреА, рд░рдХреНрддрджрд╛рди рд╣реЗрддреБ рд╕рд╣рд╛рдпрддрд╛ рдЪрд╛рд╣рд┐рдПред рдпрд╣ рдЕрдиреБрд░реЛрдз рднрд╛рдЬрдкрд╛ рдЬрд┐рд▓рд╛ рдордВрджрд╕реМрд░ рд░рдХреНрддрджрд╛рддрд╛ рдкреЛрд░реНрдЯрд▓ ( https://raktdata-mandsaur.netlify.app/ ) рд╕реЗ рд╣реИред`);
        const addressLine = d.address ? `<div><b>рдкрддрд╛:</b> ${d.address}</div>` : '';
        grd.insertAdjacentHTML('beforeend', `
          <div class="bg-white border rounded-2xl p-4 flex flex-col gap-2 hover:shadow-lg transition-shadow text-left">
            <div class="flex items-center justify-between">
              <div class="font-semibold text-slate-800 text-lg">${d.name||''}</div>
              <span class="text-base px-3 py-1 rounded-full bg-red-100 text-red-700 border border-red-200 font-bold">${d.bloodGroup||''}</span>
            </div>
            <div class="text-sm text-slate-600 space-y-1">
              <div><b>рдордВрдбрд▓:</b> ${d.mandal||'тАФ'}</div>
              ${addressLine}
              <div><b>рдореЛрдмрд╛рдЗрд▓:</b> <a class="underline font-semibold" href="tel:${d.phone||''}">${d.phone||''}</a></div>
              ${d.whatsapp ? `<div><b>рд╡реНрд╣рд╛рдЯреНрд╕рдРрдк:</b> <a class="underline font-semibold" href="https://wa.me/91${waNum}">+91 ${waNum}</a></div>` : ''}
              <div><b>рдЖрдЦрд╝рд┐рд░реА рджрд╛рди:</b> ${d.lastDonationDate? fmtTS(d.lastDonationDate):'тАФ'}</div>
            </div>
            <div class="flex gap-2 pt-2 mt-auto">
              <a class="flex-1 text-center px-3 py-2 rounded-xl bg-orange-500 text-white text-sm font-semibold hover:bg-orange-600" href="tel:${d.phone||''}">рдХреЙрд▓ рдХрд░реЗрдВ</a>
              <a class="flex-1 text-center px-3 py-2 rounded-xl bg-green-500 text-white text-sm font-semibold hover:bg-green-600" target="_blank" href="https://wa.me/91${waNum}?text=${msg}">рд╡реНрд╣рд╛рдЯреНрд╕рдРрдк рдХрд░реЗрдВ</a>
            </div>
          </div>`);
      });
    }

    document.getElementById('reqForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const $ = (id)=>document.getElementById(id);
      const payload = {
        requester: $('r_requester').value.trim(),
        phone: $('r_phone').value.trim().replace(/[^0-9]/g,''),
        patient: $('r_patient').value.trim(),
        bloodGroup: $('r_group').value,
        units: Number($('r_units').value||1),
        location: $('r_location').value.trim(),
        hospital: $('r_hospital').value.trim(),
        createdAt: serverTimestamp(),
        status: "new"
      };
      
      if (!payload.requester || !payload.phone || !payload.bloodGroup) {
          showToast('рдХреГрдкрдпрд╛ рдирд╛рдо, рдореЛрдмрд╛рдЗрд▓ рдФрд░ рдмреНрд▓рдб рдЧреНрд░реБрдк рднрд░реЗрдВред', false);
          return;
      }
      
      const msg = $('reqMsg'); msg.textContent='';
      try {
        await addDoc(collection(db,'requests'), payload);
        const modal = $('reqOkModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        $('reqOkClose').onclick = () => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        };
        sendTelegram(`ЁЯЖШ рд░рдХреНрдд рдЕрдиреБрд░реЛрдз\nрдирд╛рдо: ${payload.requester}\nрдореЛрдмрд╛рдЗрд▓: ${payload.phone}\nрд░реЛрдЧреА: ${payload.patient||'-'}\nрдмреНрд▓рдб: ${payload.bloodGroup||'-'} (${payload.units} рдпреВрдирд┐рдЯ)\nрд╕реНрдерд╛рди: ${payload.location||'-'}\nрдЕрд╕реНрдкрддрд╛рд▓/рдиреЛрдЯреНрд╕: ${payload.hospital||'-'}`);
        e.target.reset();
      } catch(err) {
        console.error(err);
        msg.className = 'text-red-700'; msg.textContent = 'тЭМ рддреНрд░реБрдЯрд┐: рдХреГрдкрдпрд╛ рдмрд╛рдж рдореЗрдВ рдкреБрдирдГ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВред';
        showToast('рдЕрдиреБрд░реЛрдз рднреЗрдЬрдиреЗ рдореЗрдВ рд╕рдорд╕реНрдпрд╛ рд╣реБрдИред', false);
      }
    });
  </script>
</body>
</html>

