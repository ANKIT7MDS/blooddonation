
<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>डोनर सर्च • रक्तदाता पोर्टल</title>
  
<!-- Tailwind + Google Font -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    theme: {
      extend: {
        fontFamily: { devanagari: ['"Noto Sans Devanagari"', 'system-ui', 'sans-serif'] },
        colors: {
          saffron: { 50:'#FFF4E8',100:'#FFE8D6',200:'#FFD7B3',300:'#FFC48A',400:'#FFA24D',500:'#FF7F0E',600:'#E06900',700:'#C25700',800:'#A34500',900:'#873800' },
          peach: { 50:'#FFF7EF',100:'#FFEFE0',200:'#FFE3C6' }
        }
      }
    }
  }
</script>
<style> body { font-family: "Noto Sans Devanagari", system-ui, sans-serif; } </style>

</head>
<body class="min-h-screen bg-slate-50">
  
<header class="bg-gradient-to-r from-saffron-800 to-saffron-600 text-white">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
    <div></div>
    <nav class="flex gap-2 text-sm">
      <a href="index.html" class="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20">डोनर सर्च</a>
      <a href="register.html" class="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20">रक्तदाता पंजीकरण</a>
      <a href="admin.html" class="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20">Admin</a>
    </nav>
  </div>
</header>


  
<section class="relative overflow-hidden">
  <div class="absolute inset-0">
    <div class="absolute inset-0 bg-gradient-to-b from-white via-peach-50 to-white opacity-95"></div>
    <div class="absolute inset-0 bg-[url('https://upload.wikimedia.org/wikipedia/commons/6/6d/Official_portrait_of_prime_minister_of_India%2C_Narendra_Modi.jpg')] bg-cover bg-right opacity-15"></div>
  </div>
  <div class="relative max-w-6xl mx-auto px-4 py-8">
    <div class="mx-auto text-center bg-white/70 backdrop-blur-sm border rounded-3xl px-4 sm:px-6 py-6 shadow">
      <div class="text-slate-800 text-base sm:text-lg font-semibold">भारतीय जनता पार्टी • जिला मंदसौर</div>
      <div class="mt-1 text-4xl sm:text-5xl font-extrabold text-red-700">रक्तदाता पोर्टल</div>
      <p class="mt-3 text-slate-700 text-sm sm:text-base max-w-3xl mx-auto">
        माननीय प्रधानमंत्री श्री नरेंद्र मोदी जी के जन्म दिवस <b>17 सितम्बर</b> के अवसर पर,
        <b>सेवा पखवाड़ा (17 सितम्बर — 2 अक्टूबर 2025)</b> हेतु यह पोर्टल आम नागरिकों की सेवा में समर्पित है।
      </p>
      <div class="mt-4 inline-flex items-center gap-3 bg-white rounded-2xl px-3 py-2 border">
        <img src="seva-pakhwada-2025-clean-1024.png" alt="सेवा पखवाड़ा 2025" class="h-12 w-auto rounded" />
        <span class="text-sm">रक्तदान • सेवा • सहयोग</span>
      </div>
    </div>
  </div>
</section>


  <main class="max-w-6xl mx-auto p-4 space-y-4">
    <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-sm border">
      <div class="flex items-center justify-between gap-2 flex-wrap">
        <h2 class="text-lg font-semibold">डोनर सर्च</h2>
        <div id="resultInfo" class="text-sm text-slate-500"></div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
        <input id="qText" class="rounded-xl border px-3 py-2" placeholder="नाम/मोबाइल/वार्ड/बूथ/पता" />
        <select id="qGroup" class="rounded-xl border px-3 py-2"></select>
        <select id="qMandal" class="rounded-xl border px-3 py-2"></select>
      </div>
      <div class="mt-3 flex flex-wrap gap-2" id="chipGroups"></div>

      <p class="mt-3 text-xs sm:text-sm text-slate-600">
        रक्तदाताओं की गोपनीयता एवं सुरक्षा नियमों के कारण आप 3 से अधिक डोनर नहीं देख सकते।
        रक्त की आवश्यकता होने पर कृपया नीचे अनुरोध भेजें; हमारी टीम शीघ्र संपर्क करेगी।
      </p>

      <div id="cardGrid" class="mt-4 grid sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
    </div>

    <!-- Request Box -->
    <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-sm border">
      <h3 class="text-base font-semibold mb-3">रक्त की आवश्यकता अनुरोध</h3>
      <p class="text-sm text-slate-600 mb-3">जरूरतमंद की जानकारी भरें—अनुरोध Admin पैनल को भेजा जाएगा (और टेलीग्राम पर भी)।</p>
      <form id="reqForm" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div>
          <label class="text-sm text-slate-600">आपका नाम</label>
          <input id="r_requester" class="mt-1 w-full rounded-xl border px-3 py-2" required />
        </div>
        <div>
          <label class="text-sm text-slate-600">मोबाइल</label>
          <input id="r_phone" class="mt-1 w-full rounded-xl border px-3 py-2" pattern="[0-9]{10}" required />
        </div>
        <div>
          <label class="text-sm text-slate-600">जरूरतमंद का नाम</label>
          <input id="r_patient" class="mt-1 w-full rounded-xl border px-3 py-2" />
        </div>
        <div>
          <label class="text-sm text-slate-600">ब्लड ग्रुप</label>
          <select id="r_group" class="mt-1 w-full rounded-xl border px-3 py-2"></select>
        </div>
        <div>
          <label class="text-sm text-slate-600">यूनिट</label>
          <input type="number" min="1" id="r_units" class="mt-1 w-full rounded-xl border px-3 py-2" value="1" />
        </div>
        <div>
          <label class="text-sm text-slate-600">स्थान</label>
          <input id="r_location" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="वार्ड/एरिया/शहर" />
        </div>
        <div class="sm:col-span-2">
          <label class="text-sm text-slate-600">अस्पताल/नोट्स</label>
          <textarea id="r_hospital" class="mt-1 w-full rounded-xl border px-3 py-2" rows="2" placeholder="अस्पताल, डॉक्टर, अन्य"></textarea>
        </div>
        <div class="sm:col-span-2 flex items-center gap-3">
          <button class="px-4 py-2 rounded-xl bg-saffron-700 text-white font-semibold">अनुरोध भेजें</button>
          <span id="reqMsg" class="text-sm"></span>
        </div>
      </form>
    </div>
  </main>

  <footer class="max-w-6xl mx-auto p-4 text-xs text-slate-500 text-center">© <span id="year"></span> भारतीय जनता पार्टी • जिला मंदसौर</footer>

  <script type="module">
    // ---- Configs ----
    const TELEGRAM_BOT_TOKEN = "8462350268:AAH2Za886P4VPrLbLWa-RcxL0pbRNwwIfKQ";
    const TELEGRAM_CHAT_ID = "@bjpbloodbot";

    const MANDALS = (arr => (arr.includes("अन्य")? arr : ["अन्य", ...arr]))(__MANDALS__);
    const BLOOD_GROUPS = __BGS__;
    const $ = (id)=>document.getElementById(id);
    const fmtDate = (ts)=>{ try{ const d = ts?.toDate? ts.toDate(): new Date(ts); return d.toLocaleDateString('en-GB'); }catch{ return '' } };
    const isWilling = (d)=>{
      if (d == null) return true;
      const w = d.willing;
      if (w === false) return false;
      if (typeof w === 'string') {
        const s = w.trim().toLowerCase();
        if (['no', 'नहीं', 'nahi', 'nai'].includes(s)) return false;
      }
      return true;
    };

    document.getElementById('year').textContent = new Date().getFullYear();

    const fill = (el, arr, first)=>{ try{ el.innerHTML=''; if(first) el.insertAdjacentHTML('beforeend', `<option value="">${first}</option>`); arr.forEach(x=> el.insertAdjacentHTML('beforeend', `<option value="${x}">${x}</option>`)); }catch(e){ console.error(e);} }
    // Search filters
    fill(document.getElementById('qGroup'), BLOOD_GROUPS, 'ब्लड ग्रुप');
    fill(document.getElementById('qMandal'), MANDALS, 'मंडल');
    // Chips
    const cg = document.getElementById('chipGroups');
    try{
      BLOOD_GROUPS.forEach(g=>{ const b=document.createElement('button'); b.className='px-3 py-1 rounded-full bg-peach-100 text-saffron-800 border hover:bg-white'; b.textContent=g; b.onclick=()=>{ document.getElementById('qGroup').value=g; render(); }; cg.appendChild(b); });
    }catch(e){ console.error(e); }

    // Request form blood groups
    fill(document.getElementById('r_group'), BLOOD_GROUPS, 'चुनें');

    // Firebase
    const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js');
    const { getFirestore, collection, onSnapshot, query, orderBy, addDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js');
    __FIREBASE__
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let donors = [];
    onSnapshot(query(collection(db,'donors'), orderBy('createdAt','desc')), snap=>{ donors = snap.docs.map(d=>({ id:d.id, ...d.data() })); render(); });

    ["qText","qGroup","qMandal"].forEach(id=> document.getElementById(id).addEventListener('input', render));

    function render(){
      const t = document.getElementById('qText').value.trim().toLowerCase();
      const g = document.getElementById('qGroup').value;
      const m = document.getElementById('qMandal').value;
      const rowsAll = donors.filter(d=>{
        const okText = !t || [d.name,d.phone,d.address,d.city].some(v=> (v||'').toLowerCase().includes(t));
        const okG = !g || d.bloodGroup===g;
        const okM = !m || d.mandal===m;
        return okText && okG && okM && isWilling(d);
      });
      const rows = rowsAll.slice(0,3); // privacy cap
      document.getElementById('resultInfo').textContent = rowsAll.length ? `${rows.length}/${rowsAll.length} परिणाम (गोपनीयता सीमा)` : 'कोई परिणाम नहीं';
      const grd = document.getElementById('cardGrid'); grd.innerHTML='';
      rows.forEach(d=>{ 
        const waNum = (d.whatsapp || d.phone || '').replace(/\D/g,'');
        const msg = encodeURIComponent(`नमस्कार ${d.name||''}, रक्तदान हेतु सहायता चाहिए।`);
        const addressLine = d.address ? `<div><b>वार्ड/बूथ/पता:</b> ${d.address}</div>` : '';
        grd.insertAdjacentHTML('beforeend', `
          <div class="bg-white border rounded-2xl p-3 flex flex-col gap-2">
            <div class="flex items-center justify-between">
              <div class="font-semibold text-slate-800">${d.name||''}</div>
              <span class="text-xs px-2 py-1 rounded-full bg-peach-100 text-saffron-800 border">${d.bloodGroup||''}</span>
            </div>
            <div class="text-sm text-slate-600">
              <div><b>मंडल:</b> ${d.mandal||'—'}</div>
              ${addressLine}
              <div><b>मोबाइल:</b> <a class="underline" href="tel:${d.phone||''}">${d.phone||''}</a></div>
              ${d.whatsapp ? `<div><b>व्हाट्सऐप:</b> <a class="underline" href="https://wa.me/${waNum}">+91 ${waNum}</a></div>` : ''}
              <div><b>आख़िरी दान:</b> ${d.lastDonationDate? fmtDate(d.lastDonationDate):'—'}</div>
            </div>
            <div class="flex gap-2 pt-1">
              <a class="px-3 py-2 rounded-xl bg-saffron-700 text-white text-sm" href="tel:${d.phone||''}">कॉल</a>
              <a class="px-3 py-2 rounded-xl bg-green-600 text-white text-sm" target="_blank" href="https://wa.me/${waNum}?text=${msg}">व्हाट्सऐप</a>
            </div>
          </div>`);
      });
    }

    // Request form submit
    document.getElementById('reqForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const msg = document.getElementById('reqMsg'); msg.textContent='';
      const payload = {
        requester: document.getElementById('r_requester').value.trim(),
        phone: document.getElementById('r_phone').value.trim().replace(/[^0-9]/g,''),
        patient: document.getElementById('r_patient').value.trim(),
        bloodGroup: document.getElementById('r_group').value,
        units: Number(document.getElementById('r_units').value||1),
        location: document.getElementById('r_location').value.trim(),
        hospital: document.getElementById('r_hospital').value.trim(),
        createdAt: serverTimestamp(),
        status: "new"
      };
      try{
        await addDoc(collection(db,'requests'), payload);
        msg.textContent = '✅ अनुरोध भेज दिया गया। हमारी टीम आपसे शीघ्र संपर्क करेगी।';
        // Telegram notify
        fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, text:
            `🆘 रक्त अनुरोध\nनाम: ${payload.requester}\nमोबाइल: ${payload.phone}\nरोगी: ${payload.patient||'-'}\nब्लड: ${payload.bloodGroup||'-'} (${payload.units} यूनिट)\nस्थान: ${payload.location||'-'}\nअस्पताल/नोट्स: ${payload.hospital||'-'}`
          })
        }).catch(()=>{});
        e.target.reset();
      }catch(err){
        console.error(err); msg.textContent = '❌ त्रुटि: कृपया बाद में पुनः प्रयास करें।';
      }
    });
  </script>
</body>
</html>
