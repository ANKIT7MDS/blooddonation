<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>рд░рдХреНрддрджрд╛рддрд╛ рдкрдВрдЬреАрдХрд░рдг тАв рд░рдХреНрддрджрд╛рддрд╛ рдкреЛрд░реНрдЯрд▓</title>

  <!-- Tailwind + Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { devanagari: ['"Noto Sans Devanagari"','system-ui','sans-serif'] },
          colors: {
            saffron:{50:'#FFF4E8',100:'#FFE8D6',200:'#FFD7B3',300:'#FFC48A',400:'#FFA24D',500:'#FF7F0E',600:'#E06900',700:'#C25700',800:'#A34500',900:'#873800'},
            peach:{50:'#FFF7EF',100:'#FFEFE0',200:'#FFE3C6'}
          }
        }
      }
    }
  </script>
  <style>
    body{ font-family:"Noto Sans Devanagari",system-ui,sans-serif }
    .toast{ position:fixed; inset-inline:0; top:10px; margin-inline:auto; width:fit-content; z-index:50 }
    .modal{ transition:opacity .2s ease }
  </style>
</head>
<body class="min-h-screen bg-peach-50">
  <div id="toast" class="toast hidden"></div>

<header class="bg-gradient-to-r from-orange-500 via-red-500 to-rose-600 text-white shadow-xl">
  <div class="max-w-6xl mx-auto px-4 py-6 text-center">
    <h1 class="text-3xl sm:text-5xl font-extrabold drop-shadow-lg">
      рднрд╛рд░рддреАрдп рдЬрдирддрд╛ рдкрд╛рд░реНрдЯреА рдЬрд┐рд▓рд╛ рдордВрджрд╕реМрд░
    </h1>
  </div>
</header>


   <main class="max-w-6xl mx-auto p-4 space-y-4">
    <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-sm border">
      <h1 class="text-2xl sm:text-3xl font-extrabold text-orange-600 mb-1 text-center sm:text-left">рд░рдХреНрддрджрд╛рддрд╛ рдкрдВрдЬреАрдХрд░рдг</h1>
      <p class="text-sm text-slate-600 mb-4 text-center sm:text-left">рдХреГрдкрдпрд╛ рд╕рд╣реА рдЬрд╛рдирдХрд╛рд░реА рднрд░реЗрдВ тАФ рдЖрд╡рд╢реНрдпрдХрддрд╛ рдкрдбрд╝рдиреЗ рдкрд░ рдЖрдкрд╕реЗ рд╕рдВрдкрд░реНрдХ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред</p>

      <form id="donorForm" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label class="text-sm text-slate-600">рдкреВрд░рд╛ рдирд╛рдо</label>
          <input required id="f_name" class="mt-1 w-full rounded-xl border px-4 py-3 text-base" placeholder="рдЬреИрд╕реЗ: рд░рд╛рдо рд╢рд░реНрдорд╛" autocomplete="name" />
        </div>
        <div>
          <label class="text-sm text-slate-600">рдореЛрдмрд╛рдЗрд▓</label>
          <input required id="f_phone" pattern="[0-9]{10}" inputmode="numeric" autocomplete="tel" class="mt-1 w-full rounded-xl border px-4 py-3 text-base" placeholder="10 рдЕрдВрдХреЛрдВ рдХрд╛ рдирдВрдмрд░" />
        </div>
        <div>
          <label class="text-sm text-slate-600">рд╡реНрд╣рд╛рдЯреНрд╕рдРрдк рдирдВрдмрд░ (рд╡реИрдХрд▓реНрдкрд┐рдХ)</label>
          <input id="f_whatsapp" pattern="[0-9]{10}" inputmode="numeric" class="mt-1 w-full rounded-xl border px-4 py-3 text-base" placeholder="рдпрджрд┐ рдореЛрдмрд╛рдЗрд▓ рд╕реЗ рдЕрд▓рдЧ рд╣реИ" />
        </div>
        <div>
          <label class="text-sm text-slate-600">рдмреНрд▓рдб рдЧреНрд░реБрдк</label>
          <select required id="f_group" class="mt-1 w-full rounded-xl border px-4 py-3 text-base"></select>
        </div>
        <div>
          <label class="text-sm text-slate-600">рдордВрдбрд▓</label>
          <select id="f_mandal" class="mt-1 w-full rounded-xl border px-4 py-3 text-base"></select>
        </div>
        <div class="sm:col-span-2">
          <label class="text-sm text-slate-600">рд╡рд╛рд░реНрдб / рдмреВрде / рдкрддрд╛</label>
          <input id="f_address" class="mt-1 w-full rounded-xl border px-4 py-3 text-base" placeholder="рдЙрджрд╛рд╣рд░рдг: рд╡рд╛рд░реНрдб 12, рдмреВрде 45, рд░рд╛рдо рдЯреЗрдХрд░реА рд░реЛрдб" />
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-sm text-slate-600">рдЙрдореНрд░</label>
            <input type="number" min="18" max="65" id="f_age" class="mt-1 w-full rounded-xl border px-4 py-3 text-base" placeholder="18-65" />
          </div>
          <div>
            <label class="text-sm text-slate-600">рд▓рд┐рдВрдЧ</label>
            <select id="f_gender" class="mt-1 w-full rounded-xl border px-4 py-3 text-base">
              <option value="">рдЪреБрдиреЗ</option>
              <option value="рдкреБрд░реБрд╖">рдкреБрд░реБрд╖</option>
              <option value="рдорд╣рд┐рд▓рд╛">рдорд╣рд┐рд▓рд╛</option>
              <option value="рдЕрдиреНрдп">рдЕрдиреНрдп</option>
            </select>
          </div>
        </div>
        <div>
          <label class="text-sm text-slate-600">рдЖрдЦрд╝рд┐рд░реА рд░рдХреНрддрджрд╛рди (рдпрджрд┐ рдХрд┐рдпрд╛ рд╣реИ)</label>
          <input type="date" id="f_last" class="mt-1 w-full rounded-xl border px-4 py-3 text-base" />
        </div>
        <div>
          <label class="text-sm text-slate-600">рдХреНрдпрд╛ рдЖрд╡рд╢реНрдпрдХрддрд╛ рдкрдбрд╝рдиреЗ рдкрд░ рд╕рдВрдкрд░реНрдХ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ?</label>
          <select id="f_willing" class="mt-1 w-full rounded-xl border px-4 py-3 text-base">
            <option value="yes">рд╣рд╛рдБ</option>
            <option value="no">рдирд╣реАрдВ</option>
          </select>
        </div>
        <div class="sm:col-span-2">
          <label class="text-sm text-slate-600">рдиреЛрдЯреНрд╕</label>
          <textarea id="f_notes" class="mt-1 w-full rounded-xl border px-4 py-3 text-base" rows="3" placeholder="рд╡рд┐рд╢реЗрд╖ рдЬрд╛рдирдХрд╛рд░реА (рдЙрджрд╛рд╣рд░рдг: рдЙрдкрд▓рдмреНрдз рд╕рдордп)"></textarea>
        </div>
        <div class="sm:col-span-2 flex items-center gap-3">
          <button id="btnSubmit" class="px-6 py-3 rounded-xl bg-orange-500 hover:bg-orange-600 text-white font-semibold w-full sm:w-auto">рдЬрдорд╛ рдХрд░реЗрдВ</button>
          <span id="formMsg" class="text-sm"></span>
        </div>
      </form>
    </div>
    
    <!-- Chart -->
    <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-sm border">
        <h3 class="text-base font-semibold mb-3">рдмреНрд▓рдб рдЧреНрд░реБрдк-рд╡рд╛рдЗрдЬрд╝ рдЙрдкрд▓рдмреНрдз рдбреЛрдирд░</h3>
        <div class="h-64"><canvas id="chartGroups"></canvas></div>
    </div>
  </main>

  <footer class="max-w-6xl mx-auto p-4 text-xs text-slate-500 text-center">┬й <span id="year"></span> рднрд╛рд░рддреАрдп рдЬрдирддрд╛ рдкрд╛рд░реНрдЯреА тАв рдЬрд┐рд▓рд╛ рдордВрджрд╕реМрд░</footer>

  <!-- Success Modal -->
  <div id="okModal" class="modal fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="bg-white w-[90%] max-w-md rounded-2xl p-6 text-center">
      <div class="text-2xl font-extrabold text-orange-600">рдзрдиреНрдпрд╡рд╛рдж!</div>
      <p class="mt-2 text-slate-700">рдЖрдкрдХрд╛ рдкрдВрдЬреАрдХрд░рдг рд╕рдлрд▓ рд░рд╣рд╛ред рдЖрд╡рд╢реНрдпрдХрддрд╛ рдкрдбрд╝рдиреЗ рдкрд░ рдЯреАрдо рдЖрдкрд╕реЗ рд╕рдВрдкрд░реНрдХ рдХрд░реЗрдЧреАред</p>
      <button id="okClose" class="mt-4 px-5 py-2 rounded-xl bg-orange-500 text-white font-semibold">рдареАрдХ рд╣реИ</button>
    </div>
  </div>

  <script>
    const MANDALS = ["рдЕрдиреНрдп","рднреЗрдВрд╕реЛрджрд╛","рднрд╛рдирдкреБрд░рд╛","рдЧрд░реЛрда","рдореЗрд▓рдЦреЗрдбрд╛","рдЦреЬрд╛рд╡рджрд╛","рд╢рд╛рдордЧреЭ","рд╕реБрд╡рд╛рд╕рд░рд╛","рдмрд╕рд╛рдИ","рд╕реАрддрд╛рдордК","рдХреНрдпрд╛рдордкреБрд░","рд╕реАрддрд╛рдордК рдЧреНрд░рд╛рдореАрдг","рдЧреБрд░реНрдЬрд░ рдмрд░рдбрд┐рдпрд╛","рдзреБрдВрдзрдзреЬрдХрд╛","рдмреБрдврд╛","рдкрд┐рдкрд▓рд┐рдпрд╛ рдордВрдбреА","рдорд▓реНрд╣рд╛рд░рдЧреЭ","рджрд▓реЛрджрд╛","рдордЧрд░рд╛рдорд╛рддрд╛ рдЬреА","рдордВрджрд╕реМрд░ рдЧреНрд░рд╛рдореАрдг","рдордВрджрд╕реМрд░ рдЙрддреНрддрд░","рдордВрджрд╕реМрд░ рджрдХреНрд╖рд┐рдг","рдЕрдиреНрдп рдЬрд┐рд▓реЗ рд╕реЗ"];
    const BLOOD_GROUPS = ["A+","A-","B+","B-","O+","O-","AB+","AB-"];
    const $ = (id)=>document.getElementById(id);
    const fill = (el, arr, first)=>{ el.innerHTML=''; if(first) el.insertAdjacentHTML('beforeend', `<option value="">${first}</option>`); arr.forEach(x=> el.insertAdjacentHTML('beforeend', `<option value="${x}">${x}</option>`)); }
    document.getElementById('year').textContent = new Date().getFullYear();
    fill($('f_group'), BLOOD_GROUPS, 'рдЪреБрдиреЗрдВ');
    fill($('f_mandal'), MANDALS, 'рдЪреБрдиреЗрдВ');

    const TELEGRAM_BOT_TOKEN = "8462350268:AAH2Za886P4VPrLbLWa-RcxL0pbRNwwIfKQ";
    const TELEGRAM_CHAT_ID   = "733804072";

    async function sendTelegram(text){
        try{
          await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, text })
          });
        }catch(_){}
    }

    function showToast(txt, ok=true){
      const t=$('toast');
      t.className='toast';
      t.innerHTML=`<div class="mx-auto max-w-lg bg-white border rounded-2xl shadow px-4 py-3 ${ok?'border-green-600':'border-red-600'}"><div class="text-sm ${ok?'text-green-700':'text-red-700'}">${txt}</div></div>`;
      setTimeout(()=>t.classList.add('hidden'), 3500);
    }
  </script>

  <script type="module">
    const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js');
    const { getFirestore, collection, addDoc, serverTimestamp, query, where, getDocs, onSnapshot, orderBy } =
      await import('https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js');

    const firebaseConfig = {
      apiKey: "AIzaSyA9LZaQJkAqr9F1YEFfRxa4aGiwvFevs9c",
      authDomain: "blodddonation-9c44e.firebaseapp.com",
      projectId: "blodddonation-9c44e",
      storageBucket: "blodddonation-9c44e.firebasestorage.app",
      messagingSenderId: "636578091772",
      appId: "1:636578091772:web:276d08168f8fc9c221fd79",
      measurementId: "G-3TPG0JCF3R"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let submitting = false;
    document.getElementById('donorForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (submitting) return;
      submitting = true;
      const btn = document.getElementById('btnSubmit'); btn.disabled = true; btn.classList.add('opacity-60');

      const $ = (id)=>document.getElementById(id);
      const msg = $('formMsg'); msg.textContent='';

      try {
        const payload = {
          name: $('f_name').value.trim(),
          phone: $('f_phone').value.trim().replace(/[^0-9]/g,''),
          whatsapp: $('f_whatsapp').value.trim().replace(/[^0-9]/g,''),
          bloodGroup: $('f_group').value,
          mandal: $('f_mandal').value,
          address: $('f_address').value.trim(),
          age: $('f_age').value ? Number($('f_age').value) : null,
          gender: $('f_gender').value,
          lastDonationDate: $('f_last').value ? new Date($('f_last').value) : null,
          willing: $('f_willing').value === 'yes',
          notes: $('f_notes').value.trim(),
          createdAt: serverTimestamp(),
        };

        if (!payload.phone || payload.phone.length !== 10) {
          throw new Error('рдХреГрдкрдпрд╛ 10 рдЕрдВрдХреЛрдВ рдХрд╛ рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░ рднрд░реЗрдВред');
        }
        if (!payload.name) throw new Error('рдХреГрдкрдпрд╛ рдкреВрд░рд╛ рдирд╛рдо рднрд░реЗрдВред');
        if (!payload.bloodGroup) throw new Error('рдХреГрдкрдпрд╛ рдмреНрд▓рдб рдЧреНрд░реБрдк рдЪреБрдиреЗрдВред');
        
        const qDup = query(collection(db,'donors'), where('phone','==', payload.phone));
        const dupSnap = await getDocs(qDup);
        if (!dupSnap.empty) {
          throw new Error('рдпрд╣ рдореЛрдмрд╛рдЗрд▓ рдкрд╣рд▓реЗ рд╕реЗ рд░рдЬрд┐рд╕реНрдЯрд░реНрдб рд╣реИред');
        }

        await addDoc(collection(db,'donors'), payload);
        
        sendTelegram(`ЁЯЖХ рдирдпрд╛ рд░рдХреНрддрджрд╛рддрд╛\nрдирд╛рдо: ${payload.name}\nрдореЛрдмрд╛рдЗрд▓: ${payload.phone}\nрдмреНрд▓рдб: ${payload.bloodGroup||'-'}\nрдордВрдбрд▓: ${payload.mandal||'-'}\nрдкрддрд╛: ${payload.address||'-'}`);
        document.getElementById('donorForm').reset();

        const okModal = document.getElementById('okModal');
        okModal.classList.remove('hidden'); okModal.classList.add('flex');
        document.getElementById('okClose').onclick = ()=>{
          okModal.classList.add('hidden'); okModal.classList.remove('flex');
        };
      } catch(err) {
        console.error(err);
        msg.className='text-red-700';
        msg.textContent='тЭМ рддреНрд░реБрдЯрд┐: ' + (err?.message || 'рдХреГрдкрдпрд╛ рдмрд╛рдж рдореЗрдВ рдкреБрдирдГ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВред');
        showToast(err?.message || 'рдкрдВрдЬреАрдХрд░рдг рдореЗрдВ рд╕рдорд╕реНрдпрд╛ рд╣реБрдИред', false);
      } finally {
        submitting = false;
        btn.disabled = false; btn.classList.remove('opacity-60');
      }
    });

    let chartGroups;
    onSnapshot(query(collection(db,'donors'), orderBy('createdAt','desc')), snap=>{
      const donors = snap.docs.map(d=> d.data());
      const groupCounts = BLOOD_GROUPS.map(g => donors.filter(d => d.bloodGroup===g && (d.willing === true || d.willing === 'yes')).length);
      const elG = document.getElementById('chartGroups');
      if(chartGroups) chartGroups.destroy();
      chartGroups = new Chart(elG, {
        type:'bar',
        data:{ labels:BLOOD_GROUPS, datasets:[{ label:'рдЙрдкрд▓рдмреНрдз рдбреЛрдирд░', data:groupCounts, backgroundColor: 'rgba(255, 127, 14, 0.6)', borderColor: 'rgba(255, 127, 14, 1)', borderWidth: 1 }] },
        options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ ticks:{ precision:0, beginAtZero: true }}}}
      });
    });

  </script>
</body>
</html>

